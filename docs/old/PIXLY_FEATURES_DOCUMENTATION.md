# Pixly 媒体转换引擎 - 完整功能文档

## 📋 目录

- [项目概述](#项目概述)
- [核心功能](#核心功能)
- [转换模式详解](#转换模式详解)
- [支持的文件格式](#支持的文件格式)
- [高级特性](#高级特性)
- [用户界面](#用户界面)
- [配置系统](#配置系统)
- [性能优化](#性能优化)
- [安全特性](#安全特性)
- [技术架构](#技术架构)
- [使用示例](#使用示例)

---

## 🎯 项目概述

**Pixly** 是一个基于 Go 语言开发的高性能媒体转换引擎，专注于现代媒体格式的智能转换和优化。项目采用 CLI 架构，提供企业级的稳定性、高效的并发处理和优雅的用户体验。

### 核心设计理念
- **智能化**: 基于文件内容和质量的智能决策
- **高效性**: 多核并发处理，内存优化管理
- **稳定性**: 企业级错误处理和容错机制
- **美观性**: 现代化 UI 设计和用户体验

---

## 🚀 核心功能

### 1. 智能媒体转换
- **自动格式检测**: 基于 Magic Number 和扩展名的双重验证
- **质量分析**: 深度图像质量评估和分类
- **智能决策**: 根据文件特性选择最优转换策略
- **批量处理**: 支持大规模文件批量转换

### 2. 三种智能转换模式

#### 🔄 自动模式+ (Auto+)
- **智能质量检测**: 自动分析图像质量等级
- **动态策略选择**: 根据文件特性选择最优转换方案
- **平衡优化**: 在质量和文件大小间找到最佳平衡点
- **无损格式优先**: 优先检测和处理无损JPEG/PNG

#### 🎨 品质模式 (Quality)
- **无损压缩优先**: 优先使用数学无损压缩
- **高质量保持**: 确保转换后质量不低于原文件
- **格式重新包装**: JPEG→JXL, PNG→JXL 的无损重新包装
- **质量阈值控制**: 基于配置的质量阈值管理

#### 😊 表情包模式 (Emoji)
- **激进压缩**: 专为表情包和简单图像设计
- **AVIF 优先**: 优先使用 AVIF 格式实现极致压缩
- **尺寸优化**: 智能调整图像尺寸以适应表情包使用场景
- **快速处理**: 针对小文件优化的快速转换流程

### 3. 高级图像分析
- **质量度量系统**: 复杂度、噪声水平、压缩潜力分析
- **内容类型识别**: 照片、图形、混合内容自动分类
- **像素密度计算**: 基于分辨率的质量评估
- **文件大小分析**: 结合文件大小的质量判断

---

## 📁 支持的文件格式

### 图像格式

#### 输入格式
- **JPEG/JPG**: 标准JPEG图像
- **PNG**: 便携式网络图形
- **GIF**: 图形交换格式（包括动画GIF）
- **WebP**: Google WebP格式
- **BMP**: 位图格式
- **TIFF**: 标记图像文件格式
- **HEIC/HEIF**: 高效图像格式

#### 输出格式
- **JXL**: JPEG XL（主要输出格式）
- **AVIF**: AV1图像文件格式

### 视频格式

#### 输入格式
- **MP4**: MPEG-4视频
- **AVI**: 音视频交错格式
- **MOV**: QuickTime视频
- **MKV**: Matroska视频
- **WMV**: Windows媒体视频
- **FLV**: Flash视频
- **3GP**: 3GPP视频

#### 输出格式
- **MOV**: 重新包装的QuickTime视频（保持原始编码）

---

## ⚡ 高级特性

### 1. 并发处理系统
- **智能工作池**: 基于 `ants/v2` 的高级并发控制
- **动态调整**: 根据系统负载自动调整并发数
- **内存监控**: 实时内存使用监控和限制
- **资源优化**: CPU和内存的智能分配

### 2. 断点续传机制
- **BBolt数据库**: 基于BBolt的检查点存储
- **原子操作**: 确保文件操作的原子性
- **状态恢复**: 程序重启后自动恢复转换进度
- **错误恢复**: 智能错误恢复和重试机制

### 3. 看门狗系统
- **子进程监控**: 实时监控FFmpeg等外部工具
- **超时控制**: 防止进程无限期挂起
- **资源清理**: 自动清理僵尸进程和临时文件
- **异常处理**: 完善的异常检测和处理

### 4. 智能文件扫描
- **两阶段扫描**: 元信息预判断 + FFmpeg深度验证
- **Magic Number检测**: 真实文件类型识别
- **问题文件识别**: 损坏、低质量文件自动标记
- **白名单过滤**: 基于扩展名和路径的智能过滤

---

## 🎨 用户界面

### 1. 现代化设计
- **ASCII艺术**: 动态动画标题和居中显示
- **主题系统**: 暗色模式和亮色模式支持
- **彩色输出**: 丰富的颜色方案和视觉效果
- **Emoji支持**: 精心设计的表情符号装饰

### 2. 交互体验
- **方向键导航**: 现代化的菜单导航方式
- **即时反馈**: 实时状态更新和进度显示
- **错误提示**: 友好的错误信息和建议
- **多语言支持**: 国际化界面支持

### 3. 进度显示
- **动态进度条**: 实时转换进度显示
- **多任务进度**: 支持多个并发任务的进度跟踪
- **统计信息**: 详细的转换统计和性能指标
- **完成报告**: 转换完成后的详细报告

---

## ⚙️ 配置系统

### 1. 配置文件管理
- **YAML配置**: 基于 `.pixly.yaml` 的配置文件
- **热重载**: 配置文件变更的实时检测和应用
- **默认配置**: 智能的默认配置和自动生成
- **配置验证**: 完整的配置项验证和错误提示

### 2. 主要配置项

#### 转换设置
```yaml
conversion:
  default_mode: "auto+"  # 默认转换模式
  quality:
    jpeg_quality: 85      # JPEG质量设置
    webp_quality: 80      # WebP质量设置
    avif_quality: 50      # AVIF质量设置
    jxl_quality: 90       # JXL质量设置
    video_crf: 23         # 视频CRF值
```

#### 并发设置
```yaml
concurrency:
  scan_workers: 4         # 扫描工作线程数
  conversion_workers: 4   # 转换工作线程数
  memory_limit: 1024      # 内存限制(MB)
  auto_adjust: true       # 自动调整并发数
```

#### 安全设置
```yaml
security:
  allowed_directories: []     # 允许的目录列表
  forbidden_directories: []   # 禁止的目录列表
  max_file_size: 1073741824  # 最大文件大小(字节)
  check_disk_space: true     # 检查磁盘空间
```

---

## 🔧 性能优化

### 1. 内存管理
- **内存池**: 高效的内存池管理
- **垃圾回收**: 智能的垃圾回收优化
- **内存监控**: 实时内存使用监控
- **内存限制**: 可配置的内存使用限制

### 2. 并发优化
- **工作池**: 基于ants的高性能工作池
- **负载均衡**: 智能的任务分配和负载均衡
- **资源调度**: CPU和I/O资源的优化调度
- **批处理**: 高效的批量文件处理

### 3. I/O优化
- **异步I/O**: 非阻塞的文件读写操作
- **缓冲管理**: 智能的缓冲区管理
- **临时文件**: 高效的临时文件处理
- **原子操作**: 确保文件操作的原子性

---

## 🔒 安全特性

### 1. 路径安全
- **路径白名单**: 严格的路径访问控制
- **路径规范化**: 防止路径遍历攻击
- **权限检查**: 文件和目录权限验证
- **符号链接处理**: 安全的符号链接处理

### 2. 文件完整性
- **校验和验证**: 文件完整性校验
- **原子操作**: 防止文件损坏的原子操作
- **备份机制**: 可选的原文件备份
- **回滚支持**: 转换失败时的自动回滚

### 3. 资源保护
- **磁盘空间检查**: 转换前的磁盘空间验证
- **文件大小限制**: 可配置的文件大小限制
- **进程监控**: 外部进程的安全监控
- **资源清理**: 自动的资源清理和释放

---

## 🏗️ 技术架构

### 1. 核心组件
- **转换器 (Converter)**: 核心转换逻辑
- **策略模式**: 可扩展的转换策略系统
- **配置管理器**: 统一的配置管理
- **UI管理器**: 用户界面和交互管理

### 2. 外部依赖
- **FFmpeg**: 视频和音频处理
- **FFprobe**: 媒体文件信息探测
- **cjxl**: JPEG XL编码器
- **avifenc**: AVIF编码器
- **exiftool**: 元数据处理

### 3. 数据流
```
文件扫描 → 质量分析 → 策略选择 → 格式转换 → 质量验证 → 结果输出
```

---

## 💡 使用示例

### 1. 基本使用
```bash
# 转换单个目录
./pixly /path/to/images

# 指定转换模式
./pixly /path/to/images --mode quality

# 保留原文件
./pixly /path/to/images --keep-original

# 生成详细报告
./pixly /path/to/images --generate-report
```

### 2. 高级选项
```bash
# 自定义并发数
./pixly /path/to/images --scan-workers 8 --conversion-workers 4

# 指定输出目录
./pixly /path/to/images --output-dir /path/to/output

# 启用调试模式
./pixly /path/to/images --debug

# 使用配置文件
./pixly /path/to/images --config /path/to/config.yaml
```

### 3. 交互模式
```bash
# 启动交互模式
./pixly

# 在交互模式中:
# - 使用方向键选择选项
# - 按Enter确认选择
# - 按ESC返回上级菜单
```

---

## 📊 性能指标

### 1. 转换效率
- **并发处理**: 支持多核并发转换
- **内存优化**: 低内存占用，支持大文件处理
- **速度优化**: 针对不同文件类型的速度优化
- **批量处理**: 高效的批量文件处理能力

### 2. 压缩效果
- **JXL格式**: 平均压缩率 30-50%
- **AVIF格式**: 平均压缩率 40-60%
- **质量保持**: 视觉质量基本无损
- **文件兼容**: 广泛的格式兼容性

---

## 🔄 版本信息

**当前版本**: v1.65.6.6  
**发布日期**: 2025年1月  
**Go版本要求**: Go 1.19+  
**平台支持**: Windows, macOS, Linux  

---

## 📞 技术支持

如需技术支持或报告问题，请参考项目文档或联系开发团队。

---

*本文档详细描述了 Pixly 媒体转换引擎的所有核心功能和特性。更多技术细节请参考源代码和其他技术文档。*