package main

import (
	"flag"
	"fmt"
	"os"
	"time"

	"go.uber.org/zap"

	"pixly/pkg/testsuite"
)

func main() {
	var (
		scenarioFile = flag.String("scenarios", "test_scenarios.json", "æµ‹è¯•åœºæ™¯é…ç½®æ–‡ä»¶è·¯å¾„")
		configFile   = flag.String("config", "", "é…ç½®æ–‡ä»¶è·¯å¾„")
		outputFile   = flag.String("output", "", "æµ‹è¯•æŠ¥å‘Šè¾“å‡ºè·¯å¾„")
		verbose      = flag.Bool("verbose", false, "å¯ç”¨è¯¦ç»†æ—¥å¿—")
		scenarioID   = flag.String("scenario", "", "è¿è¡ŒæŒ‡å®šçš„æµ‹è¯•åœºæ™¯ID")
	)
	flag.Parse()

	// åˆå§‹åŒ–æ—¥å¿—
	var logger *zap.Logger
	var err error
	
	if *verbose {
		logger, err = zap.NewDevelopment()
	} else {
		logger, err = zap.NewProduction()
	}
	
	if err != nil {
		fmt.Fprintf(os.Stderr, "Failed to initialize logger: %v\n", err)
		os.Exit(1)
	}
	defer logger.Sync()

	// åˆ›å»ºæµ‹è¯•å¥—ä»¶
	testSuite, err := testsuite.NewTestSuite(*configFile, logger)
	if err != nil {
		logger.Fatal("Failed to create test suite", zap.Error(err))
	}

	// åŠ è½½æµ‹è¯•åœºæ™¯
	if err := testSuite.LoadScenariosFromFile(*scenarioFile); err != nil {
		logger.Fatal("Failed to load scenarios", zap.Error(err))
	}

	logger.Info("åº•å±‚é€šç”¨æµ‹è¯•å¥—ä»¶å¯åŠ¨", 
		zap.String("scenarios_file", *scenarioFile),
		zap.Bool("verbose", *verbose))

	// è¿è¡Œæµ‹è¯•
	if *scenarioID != "" {
		// è¿è¡ŒæŒ‡å®šåœºæ™¯
		if err := runSingleScenario(testSuite, *scenarioID, logger); err != nil {
			logger.Fatal("Scenario execution failed", zap.Error(err))
		}
	} else {
		// è¿è¡Œæ‰€æœ‰åœºæ™¯
		if err := testSuite.RunAllScenarios(); err != nil {
			logger.Fatal("Test suite execution failed", zap.Error(err))
		}
	}

	// ç”ŸæˆæŠ¥å‘Š
	report := testSuite.GenerateReport()
	
	// è¾“å‡ºæŠ¥å‘Š
	var reportPath string
	if *outputFile != "" {
		reportPath = *outputFile
	} else {
		// ä½¿ç”¨é»˜è®¤çš„reports/testç›®å½•
		if err := os.MkdirAll("reports/test", 0755); err != nil {
			logger.Error("Failed to create reports/test directory", zap.Error(err))
		} else {
			timestamp := time.Now().Format("20060102_150405")
			reportPath = "reports/test/test_results_" + timestamp + ".json"
		}
	}
	
	if reportPath != "" {
		if err := testSuite.SaveReport(report, reportPath); err != nil {
			logger.Error("Failed to save report", zap.Error(err))
		}
	}

	// æ‰“å°æ‘˜è¦
	printSummary(report, logger)
	
	// æ ¹æ®æµ‹è¯•ç»“æœè®¾ç½®é€€å‡ºç 
	if report.FailedScenarios > 0 {
		os.Exit(1)
	}
}

func runSingleScenario(testSuite *testsuite.TestSuite, scenarioID string, logger *zap.Logger) error {
	logger.Info("Running single scenario", zap.String("id", scenarioID))
	
	// æŸ¥æ‰¾æŒ‡å®šçš„æµ‹è¯•åœºæ™¯
	var targetScenario *testsuite.TestScenario
	for _, scenario := range testSuite.Scenarios() {
		if scenario.ID == scenarioID {
			targetScenario = scenario
			break
		}
	}
	
	if targetScenario == nil {
		return fmt.Errorf("scenario not found: %s", scenarioID)
	}
	
	// æ‰§è¡Œå•ä¸ªåœºæ™¯
	result, err := testSuite.RunScenario(targetScenario)
	if err != nil {
		return fmt.Errorf("scenario execution failed: %w", err)
	}
	
	// è¾“å‡ºå•ä¸ªåœºæ™¯çš„ç»“æœ
	status := "âœ…"
	if !result.Success {
		status = "âŒ"
	}
	
	fmt.Printf("\n=== ğŸ“Š å•ä¸ªåœºæ™¯æ‰§è¡Œç»“æœ ===\n")
	fmt.Printf("%s %s (å¤„ç†:%d, æˆåŠŸ:%d, å¤±è´¥:%d, è·³è¿‡:%d)\n",
		status, targetScenario.Name,
		result.FilesProcessed, result.FilesSuccessful,
		result.FilesFailed, result.FilesSkipped)
	
	if len(result.Issues) > 0 {
		fmt.Printf("âš ï¸  é—®é¢˜:\n")
		for _, issue := range result.Issues {
			fmt.Printf("    - %s\n", issue)
		}
	}
	
	if result.QualityAnalysis != nil {
		fmt.Printf("ğŸ” è´¨é‡æ£€æµ‹: å·¥ä½œä¸­=%t, æ£€æµ‹è´¨é‡=%v, æŸåæ–‡ä»¶=%d\n",
			result.QualityAnalysis.QualityEngineWorking,
			result.QualityAnalysis.DetectedQualities,
			result.QualityAnalysis.CorruptedFiles)
	}
	
	return nil
}

func printSummary(report *testsuite.TestReport, logger *zap.Logger) {
	fmt.Printf("\n")
	fmt.Printf("=== ğŸ“Š æµ‹è¯•å¥—ä»¶æ‰§è¡Œç»“æœ ===\n")
	fmt.Printf("æ‰§è¡Œæ—¶é—´: %s\n", report.Timestamp.Format(time.RFC3339))
	fmt.Printf("æ€»åœºæ™¯æ•°: %d\n", report.TotalScenarios)
	fmt.Printf("é€šè¿‡åœºæ™¯: %d\n", report.PassedScenarios)
	fmt.Printf("å¤±è´¥åœºæ™¯: %d\n", report.FailedScenarios)
	fmt.Printf("æˆåŠŸç‡: %.1f%%\n", float64(report.PassedScenarios)/float64(report.TotalScenarios)*100)
	
	if len(report.Summary.QualityEngineIssues) > 0 {
		fmt.Printf("\nğŸš¨ è´¨é‡æ£€æµ‹å¼•æ“é—®é¢˜:\n")
		for _, issue := range report.Summary.QualityEngineIssues {
			fmt.Printf("  - %s\n", issue)
		}
	}
	
	if len(report.Summary.ConversionIssues) > 0 {
		fmt.Printf("\nâš ï¸  è½¬æ¢é—®é¢˜:\n")
		for _, issue := range report.Summary.ConversionIssues {
			fmt.Printf("  - %s\n", issue)
		}
	}

	// è¯¦ç»†ç»“æœ
	fmt.Printf("\nğŸ“‹ è¯¦ç»†ç»“æœ:\n")
	for _, result := range report.Results {
		status := "âœ…"
		if !result.Success {
			status = "âŒ"
		}
		
		fmt.Printf("%s %s (å¤„ç†:%d, æˆåŠŸ:%d, å¤±è´¥:%d, è·³è¿‡:%d)\n",
			status, result.ScenarioID, 
			result.FilesProcessed, result.FilesSuccessful, 
			result.FilesFailed, result.FilesSkipped)
			
		if len(result.Issues) > 0 {
			for _, issue := range result.Issues {
				fmt.Printf("    âš ï¸  %s\n", issue)
			}
		}
		
		// æ˜¾ç¤ºè´¨é‡åˆ†æç»“æœ
		if result.QualityAnalysis != nil {
			fmt.Printf("    ğŸ” è´¨é‡æ£€æµ‹: å·¥ä½œä¸­=%t, æ£€æµ‹è´¨é‡=%v, æŸåæ–‡ä»¶=%d\n",
				result.QualityAnalysis.QualityEngineWorking,
				result.QualityAnalysis.DetectedQualities,
				result.QualityAnalysis.CorruptedFiles)
		}
	}
	
	fmt.Printf("\n")
}