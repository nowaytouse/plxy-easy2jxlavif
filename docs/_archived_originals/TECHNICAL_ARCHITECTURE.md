# Pixly 技术架构文档

## 🏗️ 系统架构概览

Pixly 采用模块化设计，基于 Go 语言构建，遵循清洁架构原则，确保高性能、可扩展性和可维护性。

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI Interface                        │
│                     (Cobra Framework)                      │
├─────────────────────────────────────────────────────────────┤
│                     Application Layer                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │   Config    │ │   Theme     │ │    I18N     │ │  State │ │
│  │  Management │ │  Management │ │   Support   │ │Manager │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Business Logic                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Conversion Engine                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │  │   Image     │ │    Video    │ │  Framework  │       │ │
│  │  │ Converter   │ │  Converter  │ │   Manager   │       │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    Infrastructure Layer                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │   Logger    │ │  File I/O   │ │  External   │ │  Test  │ │
│  │   System    │ │  Manager    │ │   Tools     │ │ Suite  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📁 项目结构详解

### 根目录结构
```
pixly/
├── main.go                 # 程序入口点
├── go.mod                  # Go模块依赖
├── go.sum                  # 依赖校验和
├── README.md               # 项目说明
├── cmd/                    # CLI命令定义
├── pkg/                    # 公共包（可被外部引用）
├── internal/               # 内部包（仅项目内使用）
├── docs/                   # 文档目录
├── test/                   # 测试相关
├── logs/                   # 日志文件
└── reports/                # 转换报告
```

### 核心包结构

#### `/cmd` - 命令行接口
```
cmd/
├── root.go                 # Cobra根命令定义
├── convert.go              # 转换命令
├── analyze.go              # 分析命令
├── deps.go                 # 依赖检查命令
└── settings.go             # 设置命令
```

#### `/pkg` - 公共包
```
pkg/
├── converter/              # 转换器核心
│   ├── converter.go        # 主转换接口
│   ├── image.go           # 图片转换实现
│   ├── video.go           # 视频转换实现
│   └── conversion_framework.go # 转换框架
├── config/                 # 配置管理
│   ├── config.go          # 配置结构定义
│   └── loader.go          # 配置加载器
├── theme/                  # 主题管理
│   ├── theme.go           # 主题接口
│   └── default.go         # 默认主题
├── i18n/                   # 国际化
│   ├── i18n.go            # 国际化接口
│   └── messages.go        # 消息定义
└── state/                  # 状态管理
    ├── state.go           # 状态接口
    └── bbolt.go           # BBolt实现
```

#### `/internal` - 内部包
```
internal/
├── logger/                 # 日志系统
│   ├── logger.go          # 日志接口
│   └── zap.go             # Zap实现
├── ui/                     # 用户界面
│   ├── progress.go        # 进度条
│   ├── menu.go            # 菜单系统
│   └── theme.go           # UI主题
├── scanner/                # 文件扫描
│   ├── scanner.go         # 扫描接口
│   └── media.go           # 媒体文件扫描
├── strategy/               # 转换策略
│   ├── strategy.go        # 策略接口
│   ├── auto.go            # 自动模式
│   ├── quality.go         # 品质模式
│   └── emoji.go           # 表情包模式
└── test/                   # 测试框架
    ├── unified_test_manager.go
    ├── unified_test_executor.go
    └── unified_test_config.json
```

## 🔧 核心组件详解

### 1. 转换引擎 (Conversion Engine)

#### 架构设计
```go
type Converter interface {
    ConvertImage(file *MediaFile, strategy Strategy) (*ConversionResult, error)
    ConvertVideo(file *MediaFile, strategy Strategy) (*ConversionResult, error)
    GetSupportedFormats() []string
}

type Strategy interface {
    ShouldProcess(file *MediaFile) bool
    GetTargetFormat(file *MediaFile) string
    GetQualitySettings(file *MediaFile) QualityConfig
}
```

#### 转换流程
1. **文件扫描**: 识别文件类型和元数据
2. **策略选择**: 根据模式选择转换策略
3. **预处理**: 文件验证和准备
4. **转换执行**: 调用外部工具进行转换
5. **后处理**: 元数据迁移和验证
6. **结果报告**: 生成转换报告

### 2. 配置系统 (Configuration System)

#### 配置层次
1. **默认配置**: 内置默认值
2. **全局配置**: `~/.pixly/config.yaml`
3. **项目配置**: `.pixly.yaml`
4. **命令行参数**: 最高优先级

#### 配置结构
```go
type Config struct {
    General    GeneralConfig    `yaml:"general"`
    Conversion ConversionConfig `yaml:"conversion"`
    UI         UIConfig         `yaml:"ui"`
    Logging    LoggingConfig    `yaml:"logging"`
    Testing    TestingConfig    `yaml:"testing"`
}
```

### 3. 状态管理 (State Management)

#### BBolt数据库结构
```
state.db
├── conversion_sessions/    # 转换会话
├── file_cache/            # 文件缓存
├── progress_tracking/     # 进度跟踪
└── error_recovery/        # 错误恢复
```

#### 断点续传机制
1. **会话创建**: 开始转换时创建会话
2. **进度保存**: 实时保存转换进度
3. **状态检查**: 启动时检查未完成会话
4. **恢复选项**: 提供恢复或重新开始选项

### 4. 日志系统 (Logging System)

#### 日志级别
- **DEBUG**: 详细调试信息
- **INFO**: 一般信息
- **WARN**: 警告信息
- **ERROR**: 错误信息
- **FATAL**: 致命错误

#### 日志输出
- **控制台**: WARN和ERROR级别（非verbose模式）
- **文件**: 所有级别（`logs/pixly.log`）
- **结构化**: JSON格式，便于分析

### 5. 测试框架 (Testing Framework)

#### 测试类型
1. **单元测试**: 组件级别测试
2. **集成测试**: 模块间交互测试
3. **端到端测试**: 完整流程测试
4. **性能测试**: 性能基准测试

#### 测试工具
- **统一测试管理器**: 协调所有测试
- **测试执行器**: 执行具体测试
- **模拟数据生成**: 生成测试文件
- **结果验证**: 自动验证转换结果

## 🔄 数据流设计

### 转换数据流
```
输入文件 → 文件扫描 → 策略选择 → 转换执行 → 结果验证 → 报告生成
    ↓           ↓           ↓           ↓           ↓           ↓
  验证      元数据提取   参数配置    工具调用    质量检查    统计分析
    ↓           ↓           ↓           ↓           ↓           ↓
 缓存更新   进度更新    错误处理    监控看门狗  元数据迁移  用户反馈
```

### 错误处理流
```
错误发生 → 错误包装 → 日志记录 → 恢复尝试 → 用户通知
    ↓           ↓           ↓           ↓           ↓
  分类       上下文     结构化     自动重试    友好提示
    ↓           ↓           ↓           ↓           ↓
 统计       追踪       存储       回退机制    操作指导
```

## 🚀 性能优化策略

### 1. 并发处理
- **Worker Pool**: 使用ants库管理Goroutine
- **任务队列**: 基于优先级的任务调度
- **资源限制**: 动态调整并发数

### 2. 内存管理
- **流式处理**: 大文件分块处理
- **缓存策略**: LRU缓存热点数据
- **垃圾回收**: 及时释放不需要的资源

### 3. I/O优化
- **批量操作**: 减少系统调用次数
- **异步I/O**: 非阻塞文件操作
- **缓冲区**: 优化读写缓冲区大小

### 4. 算法优化
- **预处理**: 快速筛选不需要处理的文件
- **智能跳过**: 基于文件特征的智能跳过
- **增量处理**: 只处理变更的文件

## 🔒 安全设计

### 1. 文件安全
- **原子操作**: 确保文件操作的原子性
- **权限检查**: 操作前验证文件权限
- **路径验证**: 防止路径遍历攻击
- **临时文件**: 安全的临时文件处理

### 2. 进程安全
- **子进程监控**: 监控外部工具执行
- **超时控制**: 防止进程无限等待
- **资源限制**: 限制子进程资源使用
- **信号处理**: 优雅处理中断信号

### 3. 数据安全
- **输入验证**: 严格验证所有输入
- **错误隔离**: 防止错误传播
- **状态一致性**: 确保状态数据一致性
- **备份机制**: 重要操作前自动备份

## 🧪 测试策略

### 1. 测试金字塔
```
        E2E Tests (10%)
      ┌─────────────────┐
     │  端到端测试      │
    └─────────────────┘
   Integration Tests (20%)
  ┌─────────────────────┐
 │    集成测试          │
└─────────────────────┘
Unit Tests (70%)
┌─────────────────────────┐
│      单元测试            │
└─────────────────────────┘
```

### 2. 测试覆盖率目标
- **代码覆盖率**: ≥ 80%
- **分支覆盖率**: ≥ 75%
- **功能覆盖率**: 100%

### 3. 持续集成
- **自动化测试**: 每次提交自动运行
- **性能回归**: 监控性能变化
- **质量门禁**: 测试失败阻止合并

## 📈 监控和指标

### 1. 性能指标
- **转换速度**: 文件/秒
- **内存使用**: 峰值和平均值
- **CPU利用率**: 多核利用效率
- **I/O吞吐**: 读写速度

### 2. 质量指标
- **成功率**: 转换成功比例
- **压缩率**: 文件大小减少比例
- **错误率**: 各类错误发生频率
- **用户满意度**: 基于反馈的评分

### 3. 运维指标
- **可用性**: 系统正常运行时间
- **可靠性**: 故障恢复时间
- **可维护性**: 问题定位和修复时间

## 🔮 扩展性设计

### 1. 插件架构
- **转换器插件**: 支持新的转换工具
- **格式插件**: 支持新的文件格式
- **策略插件**: 自定义转换策略

### 2. API设计
- **RESTful API**: 提供HTTP接口
- **gRPC API**: 高性能RPC接口
- **WebSocket**: 实时进度推送

### 3. 分布式支持
- **任务分发**: 支持多机器并行处理
- **负载均衡**: 智能任务分配
- **故障转移**: 节点故障自动恢复

## 📚 开发指南

### 1. 代码规范
- **Go标准**: 遵循Go官方代码规范
- **注释规范**: 完整的包和函数注释
- **错误处理**: 统一的错误处理模式
- **测试规范**: 每个公共函数都有测试

### 2. 提交规范
- **提交信息**: 使用约定式提交格式
- **代码审查**: 所有代码必须经过审查
- **测试要求**: 提交前必须通过所有测试
- **文档更新**: 功能变更同步更新文档

### 3. 发布流程
- **版本管理**: 语义化版本控制
- **变更日志**: 详细的变更记录
- **兼容性**: 向后兼容性保证
- **迁移指南**: 重大变更提供迁移指南

---

**注意**: 本文档描述的是Pixly的技术架构设计，实际实现可能会根据需求变化进行调整。开发者应该定期更新此文档以保持与代码的同步。