Pixly 媒体转换引擎：AI 编码统一指导蓝图（全面重构版）
版本: v1.50.2.1 (CLI)

文档定位: 本文档是项目的唯一、绝对、排他的真实来源 (Single Source of Truth)。所有开发、测试、部署及维护活动，无论是由人类工程师还是 AI 代理执行，都必须严格、无条件、逐字逐句地遵守本文档的所有规范。本文档不仅是指导方针，更是一份可直接执行的、具备法律效力的技术规范。

‼️‼️‼️ 最高级别安全与质量警告 (CRITICAL WARNING) ‼️‼️‼️
100% 准确性原则: 所有代码实现必须保证 100% 的功能准确性、行为稳定性和执行效率。任何形式的"演示代码""假代码""无工作代码"、功能妥协、占位符、//TODO 注释或临时性解决方案都是绝对禁止的。每一行代码都必须是经过深思熟虑的、生产级别的最终代码。

责任归属: 若有任何违背，相关开发者（或 AI 代理的负责人）需承担全部责任。AI 代理必须在日志中详细记录所有偏离本文档规范的决策及其根本原因，并等待人工确认。

前置代码审查协议: 在开始任何编码工作前，必须对现有代码库进行彻底的、自动化的静态与动态分析，清理所有已废弃或不再需要的内容。此步骤必须作为构建流程的第一环，审查失败将直接中断整个构建过程。

绝对向前兼容性: 所有交付的代码都必须确保完全的向前兼容性，不得为后续开发制造任何技术债务。任何 API、数据结构或配置文件的变更，都必须提供明确的、自动化的迁移脚本和详尽的版本说明。

质量第一，禁止妥协: 功能完整性和行为预期的保障是项目的最高优先级。严禁为了赶工、简化逻辑或任何其他原因，做出任何可能损害项目长期质量、可维护性与稳定性的决策。

安全沙箱操作原则: 所有测试都必须在基于 TEST/ 目录下的文件副本构建的独立沙箱环境中进行。严禁以任何形式直接操作或修改任何原始测试文件。测试框架必须内置文件系统快照和回滚机制。

规划优先于编码: 在编写任何代码之前，必须先进行详细的算法设计、数据结构定义和错误处理路径分析，并制定细化到函数级别的 todo list。

依赖管理协议: 务必检查所有外部依赖组件的最新变更日志。项目的 go.mod 文件必须锁定在经过完全测试的依赖版本上，并使用 go mod verify 确保依赖的完整性。

更新记录: 有任何更新和改动等,必须及时记录到本文档最底部的区域

一、 项目核心指令与技术概要
Pixly 是一个基于 Go 语言的高性能媒体处理引擎，其核心为命令行界面（CLI）。

架构 (Architecture): 基于现有成熟结构进行开发。

性能 (Performance): 所有模块都必须围绕高并发、低内存占用的最终目标进行设计和优化。必须使用 ants 等成熟的 worker pools 管理 Goroutine，并进行严格的内存剖析和性能基准测试。

稳定性 (Stability): 必须实现企业级的安全与容错机制，包括文件操作原子性、子进程监控（看门狗）、基于 bbolt 的断点续传。错误处理必须采用 error wrapping，绝不允许核心功能和UI表现出现任何错乱。

自动化 (Automation): 必须内置一个强大的底层测试套件，覆盖所有代码分支和用户决策路径。主功能的任何更新都必须同步更新到测试套件中。

二、 核心工作流与系统规范
2.1 配置系统 (Configuration System)
程序必须具备一个强大且灵活的配置系统，允许用户对核心功能进行深度定制。

配置方式: 配置信息必须能通过外部文件（例如 .pixly.yaml）进行修改。

CLI交互映射: 当用户在 CLI 中调整设置时，必须能映射到真实的可操作键盘数字（如 0-9），并实时更新到配置文件中。

即时输入模式:

提供一个"即时输入即时响应"的配置选项，用于加速单字符命令的交互效率。

此功能默认关闭，以允许用户输入多位数字或更复杂的指令。用户可在配置中开启以获得更快的操作体验。

2.2 UI 表现规范 (UI Presentation Standards)
用户界面是项目的门面，必须做到美观、现代且极其稳定。

菜单装饰: 所有选项菜单的文字，都应当被精心设计的 emoji 或其他装饰性符号包围，提升视觉吸引力。

动态与交互:

程序标题必须使用美观的动态动画 ASCII 艺术字，并居中显示。

主菜单和设置菜单的导航必须通过上下方向键选择、Enter键确认的方式实现，禁止使用数字键选择。

在核心的文件处理决策界面（如选择转换模式），用户必须使用数字键进行选择，并可通过前述的"即时输入"功能加速。

色彩主题: 必须内置暗色模式和亮色模式两套不同的配色方案。配色要求新颖、现代，具有良好的视觉对比度和可读性。

布局稳定性: UI 表现绝对不应出现任何错乱，包括但不限于排版混乱、布局凌乱、元素错位等。必须从代码层面加固 UI 渲染的稳定性。

强制防呆机制:

为防止人为误操作或死循环，必须建立健全的异常输入处理机制。

当检测到用户多次输入空内容、或输入了非预期的字符时，程序应在提示后强制退出。

此防呆机制也必须在底层测试套件中得到充分的模拟和验证。

2.3 看门狗系统 (Watchdog System)
看门狗系统的核心目标是避免程序在异常情况下永久挂起。

双模式工作:

用户交互场景 (弱作用): 看门狗在此模式下静默工作，只有在检测到极端情况（如内存/磁盘耗尽、处理超大文件数小时且进度条完全停滞）时，才会触发提示，询问用户是否需要强制退出。

调试/测试场景 (强功能): 在底层测试套件运行时，看门狗必须自动启用并强制包裹整个测试流程。

超时机制:

在调试场景下，若任何子进程在 30秒 内没有任何有效计算活动，看门狗将判定其为卡死并强制终止整个程序。

2.4 标准交互流程 (Standard Interactive Workflow)
输入与验证 (Input & Validation): 启动后，程序必须能接收并处理拖拽或命令行传入的文件夹路径，并进行彻底的规范化。

扫描引擎处理 (Unified Scanning & Analysis): 这是决定项目能否达到 100% 成功率的至关重要的一环。

阶段一 (元信息预判 - 95%): 通过扩展名、Magic Number、文件大小等进行高速筛选，必须能初步识别出应跳过文件和潜在问题文件。

阶段二 (FFmpeg 深度验证 - 5%): 必须引入怀疑度评分制度。只有当一个文件的可疑特征累计达到预设阈值时，才会调用 ffprobe 进行深度分析。

结果缓存: 所有分析结果必须缓存到磁盘，结构定义可参考但不限于：

type MediaInfo struct {
    FullPath      string    // 规范化后的绝对路径
    FileSize      int64     // 文件大小（字节）
    ModTime       time.Time // 文件最后修改时间
    SHA256Hash    string    // 文件内容的 SHA256 哈希值，用于状态跟踪
    Codec         string    // 主要编解码器名称
    FrameCount    int       // 帧数
    IsAnimated    bool      // 是否为动图或视频
    IsCorrupted   bool      // 是否检测为损坏文件
    InitialQuality int      // 预估的初始质量（1-100）
}

所有耗时操作必须提供精确到小数点后两位的进度条。

问题文件决策 (Problematic File Decision):

配置驱动: 必须优先根据配置文件中的预设策略（如"总是删除"、"总是忽略"）自动处理问题文件，避免每次都强制用户进行批量决策。

默认设置: 默认设置为忽略不处理,避免非用户意图误操作。

问题文件类型: 包括但不限于：

损坏文件: 提供 [D]elete All / [I]gnore 选项。

编解码器/容器不兼容: 提供 [F]orce Process / [I]gnore 选项。

更多类型见附录。

模式选择与处理 (Mode Selection & Processing): 用户选择模式后，开始批量处理，并实时更新统计数据。

统计报告 (Statistical Report): 任务完成后，生成 💰 大小变化 报告，智能切换单位（KB/MB/GB）。

流程循环 (Process Loop): 报告展示后，按 Enter 返回初始页面，等待新任务或返回主菜单。

三、 核心处理模式技术规格
3.0 工具使用与回退机制
工具首选:

通用: 静态图用 cjxl，动图用 ffmpeg 转 AVIF。

表情包模式: 静态图用 avifenc，动图用 ffmpeg 转 AVIF。

回退机制 (Fallback): 如果首选工具执行失败，系统必须自动重试至少1次，若依旧失败则尝试回退到备用方案（如 ffmpeg 或 ImageMagick）。此过程对用户透明，仅在日志中记录。

3.1 🤖 自动模式+ (auto+)
定位: 智能决策核心，追求最佳质量体积比。

路由逻辑: 高品质文件路由至 quality 模式；其他品质文件应用下述平衡优化算法。

目标格式: 静图: JXL, 动图: AVIF (无损), 视频: MOV (重包装)。

平衡优化算法: 依次尝试无损重包 -> 数学无损压缩 -> 有损探测，每次尝试结果应当被日志记录,并根据探测结果（如体积减小哪怕1KB或比例明显）做出最终决策。

决策树:

极高/高品质/原画: 必须路由至 quality 模式的无损压缩逻辑。

中高/中低品质/中等/极低/低品质: 必须路由至下述的 平衡优化算法。

平衡优化算法 (Balancing Optimization Algorithm)参考: 此算法是 auto+ 模式处理中等品质文件的核心 仅供参考 可灵活增强。

function balancingOptimization(file):

 // 步骤 1: 无损重新包装优先

 result = attemptLosslessRepackaging(file)

 if result.isSuccess and result.size < file.size:

 return result




 // 步骤 2: 数学无损压缩

 result = attemptMathematicalLossless(file)

 if result.isSuccess and result.size < file.size:

 return result




 // 步骤 3: 有损探测

 probeResults = []

 if file.quality > 70:

 qualityTargets = [90, 85, 75]

 else:

 qualityTargets = [60, 55]




 for quality in qualityTargets:

 result = attemptLossyCompression(file, quality)

 if result.isSuccess:

 probeResults.add(result)




 // 步骤 4: 最终决策

 if not probeResults:

 return skip(file, "No optimization possible")




 bestResult = selectBestResult(probeResults, file.size) // 选择空间减小至少1kb 或减少比例明显的版本

 if bestResult:

 return bestResult

 else:

 return skip(file, "No significant size reduction")

3.2 🔥 品质模式 (quality)
定位: 最大保真度，无损优先，适用于归档场景。

目标格式: 静图: JXL, 动图: AVIF (无损), 视频: MOV (重包装)。

核心参数: JXL 压缩参数固定为 -e 9 

3.3 🚀 表情包模式 (emoji)
定位: 极限压缩，为网络分享优化。

规则: 图片强制转为 AVIF，视频直接跳过。当转换后体积减小 7%-13% 或更多时视为成功（此范围需可配置）。

四、 核心技术特性与系统保障规范
架构与性能: 采用"一次性扫描->缓存->处理"流程。并发数动态调整。所有外部依赖（ffmpeg等）必须实现版本回退机制（优先使用系统PATH，失败则使用内置版本）。

数据保真: 文件替换采用六步原子操作。元数据迁移强制使用 exiftool。必须实现文件扩展名自动修正。

文件识别: 通过 ffprobe 精确区分"静图/动图/视频"。通过 exiftool 识别 Live Photo 等特殊类型。

核心系统机制:

状态管理器: 使用 bbolt 实现断点续传，数据库位于 ~/.pixly/state.db。

安全检查器: 内置路径白名单，默认仅允许在用户主目录 ~/ 内操作，绝不允许直接操作根目录等系统级目录。操作前预检权限和磁盘空间。

五、 项目结构与技术栈
5.1 目前的项目目录结构

pixly/

├── main.go # 程序唯一入口点，负责初始化和启动 Cobra

├── go.mod # Go 模块依赖文件，版本必须锁定

├── cmd/

│ └── root.go # Cobra CLI 命令框架的根定义

├── pkg/ # 外部可见的包，可被其他项目引用

│ ├── converter/ # 转换器核心逻辑，包含所有媒体处理算法

│ │ ├── converter.go # 主转换逻辑接口和调度器

│ │ ├── image.go # 图片处理实现

│ │ └── video.go # 视频处理实现

│ ├── config/ # 配置管理（Viper），负责加载和解析 .pixly.yaml

│ ├── theme/ # 主题管理

│ ├── i18n/ # 国际化支持

│ └── state/ # 状态管理（bbolt），负责断点续传的数据库操作

├── internal/ # 仅限项目内部使用的包

│ ├── logger/ # 日志系统（Zap）的封装和初始化

│ ├── ui/ # 用户界面（mpb, color）的封装，提供统一的 UI 渲染接口

│ └── terminal/ # 终端兼容性

├── TEST/ # 存放所有自动化测试所需的媒体文件

├── .pixly.yaml # 配置文件的示例模板

└── docs/ # 存放本文档、更新日志等开发者文档





5.2 外部工具依赖 (必装)

核心: ffmpeg / ffprobe, cjxl (libjxl), avifenc (libavif), exiftool。

程序必须在启动时检查这些依赖是否存在于系统 PATH 中，如果缺少则给出明确的、用户友好的安装指引。




5.3 Go 语言核心依赖

CLI框架: github.com/spf13/cobra

配置管理: github.com/spf13/viper

日志系统: go.uber.org/zap

并发控制: github.com/panjf2000/ants/v2

系统监控: github.com/shirou/gopsutil/v3

进度条UI: github.com/vbauerster/mpb/v8

状态存储: go.etcd.io/bbolt

颜色输出: github.com/fatih/color



5.4 系统要求

操作系统: macOS (首要优化目标), Linux, Windows。




Go 版本: 1.25+

六、 附录：格式与规则
均为包括但不限于

白名单支持格式:

图片: jpg, jpeg, jpe, png, tiff, tif, webp, heif, heic (非Live Photo), gif, apng, bmp。

视频: mp4, webm, mov, mkv, avi。

注意：衍生格式额外关照。

智能跳过规则 (强制性):

特殊媒体: Live Photos, 空间媒体, 含音轨的图片。

目标格式文件: 如品质模式下已存在的 .jxl 文件。

非媒体文件: psd, pdf, doc 等。

系统/隐藏文件: 以 . 开头的文件。

技术限制: WebP 动图默认跳过，但必须在配置文件中提供一个可开启的实验性转换选项（例如转换为 JXL 动图）。

✅ 七、 已实现功能清单 (Implemented Features)
（此区域仅作参考，表明已有基础，但所有功能均需按新规范进行重构和验证）

基础功能: 时间戳保留、进度条精度、批处理原子性、路径识别等基础框架已存在。

缺陷根除: 针对历史版本中的进度条渲染、布局异常、日志污染UI等问题已有解决方案。

基础优化: 进度更新敏感度、旧版看门狗、工具路径配置等已有初步优化。

验收标准:

扫描引擎处理后，文件转换成功率必须达到 100%！

功能完全按本文档预期运行，无任何 UI 错乱。

⚠️ 八、 动态更新与开发任务清单 (To-Do & Optimization)
本区域为动态更新的唯一真实来源。所有新的开发任务、优化项和完成后的总结日志都必须在此处更新。

8.1 核心功能重构与完善
智能跳过规则增强: 提升对含音轨图片、空间媒体等特殊类型的识别准确率。

元数据迁移健壮性: 针对复杂或非标准元数据结构进行深度测试和兼容性修复。

文件扩展名自动修正: 引入基于 Magic Number 的深度分析，提高修正准确率。

8.2 系统保障机制增强
新版看门狗实现: 严格按照 2.3 章节的双模式规范重新实现看门狗。

状态管理器升级: 增强 bbolt 数据库记录，增加失败原因、重试次数等字段，实现更智能的断点续传。

8.3 测试体系扩展
底层测试套件重构:

场景真实性: 确保测试套件能 1:1 复现真实的用户交互场景。

目标导向: 测试套件的核心目标是保障交互场景的绝对稳定和顺利进行。

同步更新: 主功能有任何更新，都必须立即同步到测试套件中。

测试场景扩充: 大幅增加覆盖复杂交互、异常输入和 fuzz_input 的测试场景文件。

性能基准测试: 建立标准化的性能测试流程，对大规模文件处理进行内存剖析和性能基准测试，并量化存档。

8.4 用户体验提升
国际化支持: 将错误信息、日志和帮助文档纳入国际化管理体系。

帮助文档撰写: 撰写更详尽的用户手册，包括 FAQ 和故障排除指南。

损坏文件交互优化: 实现 2.4 章节中描述的配置驱动的决策流程。

8.5 版本更新记录 (v1.40.0.0)
- 版本号更新：从 v1.29.0.0 升级到 v1.40.0.0
- 看门狗系统增强：实现双模式工作（用户交互模式和调试/测试模式）
- 时间戳保留功能强化：增强时间戳保留的准确性和可靠性
- 批处理流程优化：完善"统一扫描->构建任务队列->批量决策->执行任务队列"的完整流程
- 测试套件扩展：增加时间戳保留功能的专门测试
- UI 显示优化：更新版本号显示和 ASCII 艺术字设计