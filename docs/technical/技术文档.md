# Pixly 技术文档

**版本**: v2.1.1  
**最后更新**: 2025年10月

## 📋 目录

- [系统架构](#系统架构)
- [项目结构](#项目结构)
- [核心模块](#核心模块)
- [技术规格](#技术规格)
- [性能优化](#性能优化)
- [依赖管理](#依赖管理)

---

## 🏗️ 系统架构

### 整体架构

Pixly 采用模块化设计，基于 Go 语言构建，遵循清洁架构原则。

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI Interface                        │
│                     (Cobra Framework)                      │
├─────────────────────────────────────────────────────────────┤
│                     Application Layer                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │   Config    │ │   Theme     │ │    I18N     │ │  State │ │
│  │  Management │ │  Management │ │   Support   │ │Manager │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Business Logic                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Conversion Engine                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │  │   Image     │ │    Video    │ │  Framework  │       │ │
│  │  │ Converter   │ │  Converter  │ │   Manager   │       │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    Infrastructure Layer                    │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌────────┐ │
│  │   Logger    │ │  File I/O   │ │  External   │ │  Test  │ │
│  │   System    │ │  Manager    │ │   Tools     │ │ Suite  │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 设计原则

1. **模块化**: 各功能模块独立，易于维护和扩展
2. **清洁架构**: 业务逻辑与基础设施分离
3. **高性能**: 并发处理，智能资源管理
4. **可靠性**: 原子操作，自动恢复，断点续传
5. **可测试性**: 完善的测试套件

---

## 📁 项目结构

### 根目录结构
```
pixly/
├── main.go                 # 程序入口
├── go.mod                  # Go模块依赖
├── go.sum                  # 依赖校验和
├── cmd/                    # CLI命令定义
│   └── launcher.go
├── config/                 # 配置管理
│   └── config.go
├── pkg/                    # 核心包
│   ├── atomic/            # 原子文件操作
│   ├── batchdecision/     # 批处理决策
│   ├── concurrency/       # 并发管理
│   ├── conversion/        # 转换引擎
│   ├── core/              # 核心类型和配置
│   ├── engine/            # 处理引擎
│   ├── errorhandling/     # 错误处理
│   ├── ffmpegrouter/      # FFmpeg 路由
│   ├── manager/           # 任务管理
│   ├── metamigrator/      # 元数据迁移
│   ├── monitor/           # 进程监控
│   ├── progress/          # 进度跟踪
│   ├── progressui/        # 进度UI
│   ├── quality/           # 质量评估
│   ├── scanner/           # 文件扫描
│   ├── security/          # 安全检查
│   ├── state/             # 状态管理
│   ├── tools/             # 工具管理
│   ├── ui/                # 用户界面
│   └── validation/        # 验证模块
├── easymode/              # 简易工具集
│   ├── all2avif/
│   ├── all2jxl/
│   ├── deduplicate_media/
│   ├── dynamic2avif/
│   ├── dynamic2jxl/
│   ├── merge_xmp/
│   ├── static2avif/
│   ├── static2jxl/
│   ├── utils/            # 共享工具库
│   └── video2mov/
├── tests/                 # 测试套件
│   ├── automation/       # 自动化测试
│   ├── benchmark/        # 性能测试
│   ├── integration/      # 集成测试
│   ├── scenarios/        # 场景测试
│   └── standalone/       # 独立测试
├── docs/                  # 文档
├── logs/                  # 日志文件
└── reports/               # 转换报告
```

---

## 🔧 核心模块

### 1. 转换引擎 (pkg/engine/)

**职责**: 媒体文件格式转换的核心逻辑

**主要组件**:
- `conversion_engine.go`: 主转换引擎
- `autoplus_router.go`: 自动模式路由
- `balance_optimizer.go`: 平衡优化器
- `processing_modes.go`: 处理模式定义
- `simple_converter.go`: 简单转换器

**核心接口**:
```go
type ConversionEngine interface {
    Convert(file *types.MediaFile) (*types.ConversionResult, error)
    SelectFormat(file *types.MediaFile) (string, error)
    ValidateResult(result *types.ConversionResult) bool
}
```

### 2. 并发管理 (pkg/concurrency/)

**职责**: 智能并发控制和资源管理

**功能**:
- 基于系统资源的动态并发数调整
- Worker pool 管理（使用 ants）
- 任务队列和优先级调度
- 内存和CPU使用监控

**核心结构**:
```go
type SmartConcurrency struct {
    workerPool   *ants.Pool
    maxWorkers   int
    activeWorkers int
    memoryLimit  uint64
    cpuLimit     float64
}
```

### 3. 文件扫描 (pkg/scanner/)

**职责**: 媒体文件扫描和类型检测

**功能**:
- 递归目录遍历
- 文件类型识别
- MIME 类型检测
- 元数据提取

### 4. 质量评估 (pkg/quality/)

**职责**: 文件质量分析和优化建议

**功能**:
- 文件品质评分
- 压缩参数建议
- 转换策略选择
- 质量损失预测

### 5. 原子操作 (pkg/atomic/)

**职责**: 安全的文件操作

**功能**:
- 原子写入
- 临时文件管理
- 失败回滚
- 数据完整性验证

### 6. 状态管理 (pkg/state/)

**职责**: 转换状态持久化和断点续传

**实现**: 使用 BBolt 嵌入式数据库

**功能**:
- 转换进度保存
- 失败任务记录
- 断点续传支持
- 历史记录管理

### 7. 进程监控 (pkg/monitor/)

**职责**: 外部进程监控和看门狗

**功能**:
- 子进程超时检测
- 卡死进程识别
- 自动终止和恢复
- 资源使用监控

### 8. 元数据迁移 (pkg/metamigrator/)

**职责**: 元数据的提取、转换和保留

**功能**:
- EXIF 数据提取
- XMP 元数据处理
- 跨格式元数据迁移
- 元数据验证

---

## 📊 技术规格

### 转换模式

#### Auto+ 模式（智能自动）
- **静态图片**: 
  - 高品质 → JXL 无损 (-e 9)
  - 中等品质 → JXL 平衡 (-e 7)
  - 低品质 → AVIF 有损 (quality 80)
- **动态图片**: AVIF 无损
- **视频文件**: MOV 重封装

#### Quality 模式（品质优先）
- **静态图片**: JXL 最高质量 (-e 9, -d 0)
- **动态图片**: AVIF 无损
- **视频文件**: MOV 重封装

#### Emoji 模式（极限压缩）
- **所有图片**: AVIF 有损 (quality 50-70)
- **视频文件**: 跳过

### 支持的格式

**输入格式**:
- 图片: JPG, PNG, GIF, WebP, HEIC, HEIF, TIFF, BMP, JXL, AVIF
- 视频: MP4, MOV, AVI, WebM, MKV, FLV
- 文档: PDF

**输出格式**:
- 图片: JXL, AVIF
- 视频: MOV

### 性能参数

| 指标 | 规格 |
|------|------|
| 默认并发数 | CPU核心数 |
| 最大并发数 | 2 × CPU核心数 |
| 单文件超时 | 动态计算（基于文件大小） |
| 内存池大小 | 自适应 |
| 日志缓冲区 | 1MB |
| 进度更新频率 | 100ms |

### 质量参数

| 格式 | 参数 | 默认值 |
|------|------|--------|
| JXL | effort | 7 (质量模式: 9) |
| JXL | distance | 0 (无损) |
| AVIF | quality | 50-90 (模式相关) |
| AVIF | speed | 6 |

---

## ⚡ 性能优化

### 1. 并发策略

```go
// 根据文件大小动态调整并发
func (sc *SmartConcurrency) AdjustConcurrency(fileSize int64) {
    if fileSize > 100*MB {
        sc.maxWorkers = max(1, sc.cpuCores/2)
    } else {
        sc.maxWorkers = sc.cpuCores * 2
    }
}
```

### 2. 内存管理

- 内存池复用
- 大文件流式处理
- 及时释放资源
- 垃圾回收优化

### 3. I/O优化

- 异步文件操作
- 批量读写
- 缓冲区优化
- SSD友好的访问模式

### 4. 缓存策略

- 文件类型检测结果缓存
- 元数据缓存
- 工具依赖检查缓存

---

## 📦 依赖管理

### Go 依赖

```go
require (
    github.com/fatih/color v1.18.0          // 终端颜色输出
    github.com/h2non/filetype v1.1.3        // 文件类型检测
    github.com/karrick/godirwalk v1.17.0    // 高效目录遍历
    github.com/panjf2000/ants/v2 v2.11.3    // Worker pool
    github.com/shirou/gopsutil/v3 v3.24.5   // 系统信息
    github.com/stretchr/testify v1.11.1     // 测试框架
    github.com/vbauerster/mpb/v8 v8.10.2    // 进度条
    go.etcd.io/bbolt v1.4.3                 // 嵌入式数据库
    go.uber.org/zap v1.27.0                 // 日志系统
)
```

### 外部工具依赖

| 工具 | 用途 | 必需 |
|------|------|------|
| ffmpeg | 视频处理、AVIF编码 | 是 |
| cjxl | JXL编码 | 是 |
| djxl | JXL解码 | 是 |
| exiftool | 元数据处理 | 是 |
| avifenc | AVIF编码（可选） | 否 |

### 安装依赖

```bash
# macOS
brew install ffmpeg jpeg-xl exiftool

# Ubuntu/Debian
sudo apt install ffmpeg libjxl-tools exiftool

# 验证
./pixly deps
```

---

## 🧪 测试策略

### 测试层次

1. **单元测试**: 各模块独立测试
2. **集成测试**: 模块间协作测试
3. **端到端测试**: 完整转换流程测试
4. **性能测试**: 并发和资源使用测试
5. **UI测试**: 交互界面自动化测试

### 测试覆盖率目标

- 核心模块: >85%
- 工具模块: >70%
- 整体目标: >80%

---

## 🔐 安全设计

### 1. 文件操作安全

- 原子写入操作
- 临时文件隔离
- 失败自动回滚
- 权限检查

### 2. 输入验证

- 路径安全检查
- 文件类型验证
- 大小限制
- 恶意文件检测

### 3. 资源限制

- 内存使用上限
- CPU使用限制
- 并发数控制
- 超时保护

### 4. 错误处理

- 全面的错误捕获
- 错误信息脱敏
- 详细的日志记录
- 优雅的降级策略

---

## 📈 监控和日志

### 日志级别

- **DEBUG**: 详细调试信息
- **INFO**: 一般操作信息
- **WARN**: 警告信息
- **ERROR**: 错误信息
- **FATAL**: 致命错误

### 日志输出

- 文件日志: `logs/pixly.log`
- 控制台输出: 可配置颜色和格式
- 结构化日志: JSON格式支持

### 监控指标

- 转换成功率
- 平均处理时间
- 内存使用情况
- CPU使用情况
- 文件大小变化
- 错误统计

---

## 🚀 部署要求

### 最低要求

- **操作系统**: macOS 10.15+, Ubuntu 20.04+, Windows 10+
- **CPU**: 2核心
- **内存**: 4GB
- **存储**: 10GB可用空间
- **Go版本**: 1.19+

### 推荐配置

- **操作系统**: macOS 13+, Ubuntu 22.04+
- **CPU**: 4核心或更多
- **内存**: 8GB或更多
- **存储**: SSD, 50GB+
- **Go版本**: 1.21+

---

## 📚 参考资料

### 相关标准

- JPEG XL: ISO/IEC 18181
- AVIF: AV1 Image File Format
- EXIF: Exchangeable Image File Format
- XMP: Extensible Metadata Platform

### 工具文档

- [FFmpeg Documentation](https://ffmpeg.org/documentation.html)
- [JPEG XL Reference](https://jpeg.org/jpegxl/)
- [AVIF Specification](https://aomediacodec.github.io/av1-avif/)
- [ExifTool Documentation](https://exiftool.org/)

---

**文档维护**: 请在代码重大变更后及时更新本文档。
