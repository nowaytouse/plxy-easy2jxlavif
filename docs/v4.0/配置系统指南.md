# Pixly v4.0 配置系统指南

## 📋 目录

- [概述](#概述)
- [快速开始](#快速开始)
- [配置文件](#配置文件)
- [配置加载优先级](#配置加载优先级)
- [完整配置参考](#完整配置参考)
- [命令行参数](#命令行参数)
- [配置迁移](#配置迁移)
- [高级用法](#高级用法)
- [常见问题](#常见问题)

---

## 概述

Pixly v4.0引入了全新的YAML配置系统，提供200+可配置参数，让您完全掌控转换行为。

### ✨ 主要特性

- **YAML格式** - 清晰、易读、易编辑
- **200+参数** - 几乎所有行为都可自定义
- **多级优先级** - 支持命令行/环境变量/配置文件/默认值
- **自动验证** - 加载时自动验证配置有效性
- **配置迁移** - 自动从v3.1.1迁移
- **实时重载** - 支持运行时重新加载配置（未来）

---

## 快速开始

### 1. 初始化配置

首次使用时，运行以下命令创建默认配置：

```bash
pixly config init
```

这将在`~/.pixly/config.yaml`创建配置文件。

### 2. 查看当前配置

```bash
pixly config show
```

### 3. 编辑配置

使用您喜欢的编辑器编辑配置文件：

```bash
vi ~/.pixly/config.yaml
# 或
code ~/.pixly/config.yaml
# 或
nano ~/.pixly/config.yaml
```

### 4. 验证配置

编辑后验证配置有效性：

```bash
pixly config validate
```

---

## 配置文件

### 配置文件位置

Pixly会按以下顺序搜索配置文件：

1. `~/.pixly/config.yaml` （用户配置，推荐）
2. `./.pixly.yaml` （项目配置）
3. `--config` 指定的路径（命令行）

### 配置文件结构

配置文件分为14个主要部分：

```yaml
project:          # 项目信息
concurrency:      # 并发控制
conversion:       # 转换设置
output:           # 输出设置
security:         # 安全设置
problem_files:    # 问题文件处理
resume:           # 断点续传
ui:               # 用户界面
logging:          # 日志设置
tools:            # 工具路径
knowledge_base:   # 知识库设置
advanced:         # 高级设置
language:         # 多语言
update:           # 更新检查
```

---

## 配置加载优先级

配置值的优先级（从高到低）：

1. **命令行参数** - 最高优先级
   ```bash
   pixly convert /path --workers 4 --mode auto+
   ```

2. **环境变量** - 使用`PIXLY_`前缀
   ```bash
   export PIXLY_CONCURRENCY_CONVERSION_WORKERS=8
   export PIXLY_UI_MODE=silent
   ```

3. **配置文件** - YAML配置文件
   ```yaml
   concurrency:
     conversion_workers: 8
   ```

4. **默认值** - 内置默认值（最低）

### 示例：Worker数量决策

```bash
# 默认值: 8
# config.yaml: conversion_workers: 12
# 环境变量: PIXLY_CONCURRENCY_CONVERSION_WORKERS=6
# 命令行: --workers 4
# 最终使用: 4 (命令行参数优先级最高)
```

---

## 完整配置参考

### 项目信息

```yaml
project:
  name: "Pixly"
  version: "4.0.0"
  author: "Pixly Team"
```

### 并发控制

```yaml
concurrency:
  auto_adjust: true          # 自动调整worker数量
  conversion_workers: 8      # 转换worker数（推荐: CPU核心数 * 1-2）
  scan_workers: 4            # 扫描worker数
  memory_limit_mb: 8192      # 内存限制（MB）
  enable_monitoring: true    # 启用性能监控
```

**调优建议：**
- 8核CPU: `conversion_workers: 8-12`
- 16核CPU: `conversion_workers: 12-20`
- 内存充足: 可提高worker数
- 内存紧张: 降低worker数

### 转换设置

#### 基本设置

```yaml
conversion:
  default_mode: "auto+"      # 默认模式
  # 可选值:
  #   auto+  - 智能预测+探索（推荐）
  #   auto   - 智能预测
  #   smart  - 智能模式（别名）
  #   batch  - 批量处理
```

#### 预测引擎

```yaml
  predictor:
    enable_knowledge_base: true    # 启用知识库学习
    confidence_threshold: 0.8      # 置信度阈值（0-1）
    enable_exploration: true       # 低置信度时启用探索
    exploration_candidates: 3      # 探索候选数量
```

#### 格式配置 - PNG

```yaml
  formats:
    png:
      target: "jxl"              # 目标格式
      lossless: true             # 100%无损
      distance: 0                # 质量距离（0=完美）
      effort: 7                  # 压缩effort (1-9)
      effort_large_file: 5       # >10MB文件使用更快的effort
      effort_small_file: 9       # <100KB文件使用更高effort
      large_file_size_mb: 10
      small_file_size_kb: 100
```

**PNG Effort参数说明：**
- `1-3`: 快速，压缩率较低
- `4-6`: 平衡，推荐日常使用
- `7-9`: 最佳压缩，耗时较长

#### 格式配置 - JPEG

```yaml
    jpeg:
      target: "jxl"              # 目标格式
      lossless_jpeg: true        # JPEG可逆转换（推荐）
      effort: 7                  # 压缩effort
```

#### 格式配置 - GIF

```yaml
    gif:
      static_target: "jxl"       # 静态GIF → JXL
      animated_target: "avif"    # 动态GIF → AVIF
      static_distance: 0         # 静态图无损
      animated_crf: 30           # 动图CRF (18-40推荐)
      animated_speed: 6          # 编码速度 (0-10)
```

**GIF CRF参数说明：**
- `18-23`: 极高质量，文件较大
- `24-30`: 高质量（推荐）
- `31-40`: 平衡质量和大小
- `41-51`: 低质量，极小文件

#### 格式配置 - WebP

```yaml
    webp:
      static_target: "jxl"       # 静态WebP
      animated_target: "avif"    # 动态WebP
```

#### 格式配置 - 视频

```yaml
    video:
      target: "mov"              # 目标格式
      repackage_only: true       # ⚠️ 推荐：仅重封装
      enable_reencode: false     # ⚠️ 慎用：重编码会损失质量
      crf: 23                    # 如果重编码，使用的CRF
```

#### 质量阈值

```yaml
  quality_thresholds:
    enable: true
    image:                       # bytes/pixel
      high_quality: 2.0          # > 2.0 = 高质量
      medium_quality: 0.5
      low_quality: 0.1
    photo:
      high_quality: 3.0
      medium_quality: 1.0
      low_quality: 0.1
    animation:
      high_quality: 20.0
      medium_quality: 1.0
      low_quality: 0.1
    video:
      high_quality: 100.0
      medium_quality: 10.0
      low_quality: 1.0
```

#### 支持的格式

```yaml
  supported_extensions:
    image:
      - ".jpg"
      - ".jpeg"
      - ".png"
      - ".gif"
      - ".bmp"
      - ".tiff"
      - ".webp"
      - ".heic"
      - ".heif"
    video:
      - ".mp4"
      - ".avi"
      - ".mkv"
      - ".mov"
      - ".flv"
      - ".m4v"
      - ".3gp"
  
  excluded_extensions:
    - ".jxl"      # 已转换格式
    - ".avif"
```

### 输出设置

```yaml
output:
  keep_original: false       # 保留原文件（原地替换时）
  generate_report: true      # 生成转换报告
  generate_performance_report: true  # 生成性能报告
  report_format: "both"      # json, txt, both
  filename_template: ""      # 文件名模板（高级）
  directory_template: ""     # 目录模板（高级）
```

### 安全设置

```yaml
security:
  enable_path_check: true    # 路径安全检查
  forbidden_directories:     # 禁止访问的目录
    - "/System"
    - "/Library"
    - "/Applications"
    # ... 更多系统目录
  allowed_directories: []    # 允许的目录（空=所有非禁止）
  check_disk_space: true     # 检查磁盘空间
  min_free_space_mb: 1024    # 最小剩余空间
  max_file_size_mb: 10240    # 最大文件大小（10GB）
  enable_backup: true        # 启用备份
```

### 问题文件处理

```yaml
problem_files:
  corrupted_strategy: "skip"    # skip, ignore, delete
  codec_incompatible_strategy: "skip"
  container_incompatible_strategy: "skip"
  trash_strategy: "delete"      # skip, delete, move
  trash_extensions:
    - ".tmp"
    - ".bak"
    - ".old"
  trash_keywords:
    - "temp"
    - "cache"
```

### 断点续传

```yaml
resume:
  enable: true               # 启用断点续传
  save_interval: 10          # 每10个文件保存一次
  auto_resume_on_crash: false  # 崩溃后自动续传
  prompt_user: true          # 提示用户选择
```

### UI设置

```yaml
ui:
  mode: "interactive"        # interactive, non-interactive, silent
  theme: "dark"              # dark, light, auto
  enable_emoji: true         # 启用Emoji图标
  enable_ascii_art: true     # 启用ASCII艺术
  enable_animations: true    # 启用动画效果
  animation_intensity: "normal"  # low, normal, high
  
  colors:                    # Dracula主题
    primary: "#00ff9f"       # Gemini绿
    secondary: "#bd93f9"     # 紫色
    success: "#50fa7b"
    warning: "#ffb86c"
    error: "#ff5555"
    info: "#8be9fd"
  
  progress:
    refresh_interval_ms: 100   # 刷新间隔
    anti_flicker: true         # 防闪烁
    show_file_icons: true      # 文件图标
    show_eta: true             # 显示ETA
  
  monitor_panel:
    enable: true               # 启用监控面板
    position: "top"            # top, bottom, left, right
    refresh_interval_s: 3      # 刷新间隔
    show_charts: false         # ASCII图表（未来）
```

### 日志设置

```yaml
logging:
  level: "info"              # debug, info, warn, error
  output: "file"             # console, file, both
  file_path: "~/.pixly/logs/pixly.log"
  max_size_mb: 100           # 单文件最大大小
  max_backups: 3             # 保留旧日志数
  max_age_days: 7            # 保留天数
  compress: true             # 压缩旧日志
```

### 工具路径

```yaml
tools:
  auto_detect: true          # 自动检测（推荐）
  cjxl_path: ""              # 留空=自动
  djxl_path: ""
  avifenc_path: ""
  avifdec_path: ""
  ffmpeg_path: ""
  ffprobe_path: ""
  exiftool_path: ""
```

### 知识库设置

```yaml
knowledge_base:
  enable: true               # 启用知识库
  db_path: "~/.pixly/knowledge.db"
  auto_learn: true           # 自动学习
  min_confidence: 0.8        # 最小置信度
  analysis:
    enable: true             # 统计分析
    report_interval: 100     # 每100个文件生成分析
    show_suggestions: true   # 显示优化建议
```

### 高级设置

```yaml
advanced:
  enable_experimental: false  # 实验性功能
  enable_debug: false        # 调试模式
  memory_pool:
    enable: true             # 内存池
    buffer_size_mb: 64
  validation:
    enable_pixel_check: false  # 像素级验证（慢）
    enable_hash_check: false   # 哈希验证
    magic_byte_check: true     # 魔术字节验证
    size_ratio_check: true     # 大小比验证
    max_size_ratio: 1.5        # 最大膨胀倍数
```

### 多语言

```yaml
language:
  default: "zh_CN"           # zh_CN, en_US, ja_JP
  auto_detect: true          # 自动检测系统语言
```

### 更新检查

```yaml
update:
  auto_check: true           # 自动检查更新
  check_interval_days: 7     # 检查间隔
  notify_on_update: true     # 通知
```

---

## 命令行参数

### 常用参数

```bash
# 指定配置文件
pixly convert /path --config /path/to/config.yaml

# Worker数量
pixly convert /path --workers 4

# 转换模式
pixly convert /path --mode auto+

# UI模式
pixly convert /path --ui-mode silent

# 日志级别
pixly convert /path --log-level debug

# 性能监控
pixly convert /path --enable-monitoring

# 保留原文件
pixly convert /path --keep-original

# PNG Effort
pixly convert /path --png-effort 9

# 禁用动画
pixly convert /path --no-animations

# UI主题
pixly convert /path --theme dark
```

### 组合使用

```bash
# 高性能模式
pixly convert /path \
  --workers 16 \
  --mode auto+ \
  --enable-monitoring \
  --png-effort 5 \
  --log-level info

# 静默批量模式
pixly convert /path \
  --ui-mode silent \
  --mode batch \
  --workers 8 \
  --no-animations

# 质量优先模式
pixly convert /path \
  --png-effort 9 \
  --jpeg-effort 9 \
  --keep-original \
  --enable-monitoring
```

---

## 配置迁移

### 从v3.1.1迁移

如果您从v3.1.1升级，Pixly会自动检测并提示迁移：

```bash
# 自动迁移
pixly config migrate

# 手动指定旧配置
pixly config migrate --from /path/to/old/config.json
```

### 迁移映射

| v3.1.1配置 | v4.0配置 |
|-----------|----------|
| `default_workers` | `concurrency.conversion_workers` |
| `replace_originals` | `output.keep_original` (反向) |
| `log_file_name` | `logging.file_path` |
| `default_verify_mode` | `advanced.validation.*` |

---

## 高级用法

### 项目特定配置

为特定项目创建`.pixly.yaml`：

```bash
cd /my/project
cat > .pixly.yaml << EOF
conversion:
  default_mode: "batch"
  formats:
    png:
      effort: 9  # 高质量项目
output:
  keep_original: true  # 保留原文件
EOF
```

### 环境变量配置

适用于CI/CD或自动化场景：

```bash
# 设置环境变量
export PIXLY_CONCURRENCY_CONVERSION_WORKERS=16
export PIXLY_UI_MODE=silent
export PIXLY_LOGGING_LEVEL=debug

# 运行Pixly（会自动读取环境变量）
pixly convert /path
```

### 配置模板

创建不同场景的配置模板：

```bash
# 高性能模板
cp ~/.pixly/config.yaml ~/.pixly/config_performance.yaml
# 编辑：workers=16, effort=5

# 高质量模板
cp ~/.pixly/config.yaml ~/.pixly/config_quality.yaml
# 编辑：workers=4, effort=9

# 使用模板
pixly convert /path --config ~/.pixly/config_performance.yaml
```

---

## 常见问题

### Q: 配置文件在哪里？
**A**: 默认位置是`~/.pixly/config.yaml`。运行`pixly config show`查看当前使用的配置路径。

### Q: 如何重置配置为默认值？
**A**: 删除配置文件并重新初始化：
```bash
rm ~/.pixly/config.yaml
pixly config init
```

### Q: 命令行参数会被保存吗？
**A**: 不会。命令行参数仅影响当前运行，不会修改配置文件。

### Q: 如何知道当前使用的配置值？
**A**: 运行`pixly config show`查看完整的配置摘要。

### Q: 配置验证失败怎么办？
**A**: 运行`pixly config validate`查看详细错误信息，根据提示修正配置。

### Q: 可以在运行时修改配置吗？
**A**: 当前版本不支持。请修改配置文件后重新运行Pixly。

### Q: 如何备份配置？
**A**: 
```bash
cp ~/.pixly/config.yaml ~/.pixly/config.yaml.backup
```

### Q: Worker数量设置多少合适？
**A**: 
- 建议：CPU核心数 × 1-2
- 8核CPU: 8-12 workers
- 16核CPU: 12-20 workers
- 内存紧张时降低worker数

### Q: 如何禁用性能监控？
**A**: 设置`concurrency.enable_monitoring: false`或使用`--no-monitoring`

### Q: 配置文件支持注释吗？
**A**: 是的！YAML格式支持`#`注释。

---

## 最佳实践

### 1. 开发环境配置

```yaml
# ~/.pixly/config_dev.yaml
concurrency:
  conversion_workers: 4  # 低worker避免开发机卡顿
  enable_monitoring: true
logging:
  level: "debug"         # 详细日志
  output: "both"         # 同时输出到控制台和文件
advanced:
  enable_debug: true
```

### 2. 生产环境配置

```yaml
# ~/.pixly/config_prod.yaml
concurrency:
  auto_adjust: true
  conversion_workers: 16  # 高性能
  enable_monitoring: true
logging:
  level: "info"          # 适中日志
  output: "file"         # 仅文件
output:
  generate_performance_report: true
```

### 3. 批量自动化配置

```yaml
# ~/.pixly/config_batch.yaml
ui:
  mode: "silent"         # 静默模式
  enable_animations: false
concurrency:
  conversion_workers: 20
output:
  generate_report: true
logging:
  level: "warn"          # 仅记录警告和错误
```

---

## 相关文档

- [Pixly v4.0 用户手册](./用户手册.md)
- [性能优化指南](./性能优化指南.md)
- [API文档](./API文档.md)
- [更新日志](./更新日志.md)

---

**最后更新**: 2025-10-25  
**版本**: v4.0.0

