# Pixly v4.0 - BoltDBæ–­ç‚¹ç»­ä¼ ç³»ç»ŸæŒ‡å—

**ç‰ˆæœ¬**: v4.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
5. [APIå‚è€ƒ](#apiå‚è€ƒ)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ç³»ç»Ÿæ¦‚è¿°

### ğŸ¯ ç›®æ ‡

ä½¿ç”¨BoltDBæ›¿æ¢JSONæ–‡ä»¶ï¼Œå®ç°ä¸“ä¸šçº§æ–­ç‚¹ç»­ä¼ å’Œä¼šè¯ç®¡ç†ç³»ç»Ÿï¼Œç¡®ä¿å¤§è§„æ¨¡è½¬æ¢ä»»åŠ¡çš„å¯é æ€§å’Œå¯æ¢å¤æ€§ã€‚

### âœ¨ ç‰¹æ€§

- **ä¸“ä¸šçº§å­˜å‚¨**: ä½¿ç”¨BoltDBåµŒå…¥å¼æ•°æ®åº“ï¼Œæ”¯æŒACIDäº‹åŠ¡
- **è‡ªåŠ¨ä¿å­˜**: æ¯å¤„ç†Nä¸ªæ–‡ä»¶è‡ªåŠ¨ä¿å­˜è¿›åº¦
- **å´©æºƒæ¢å¤**: ç¨‹åºå´©æºƒåå¯è‡ªåŠ¨æ£€æµ‹å¹¶æ¢å¤
- **ä¼šè¯ç®¡ç†**: å¤šä¼šè¯æ”¯æŒï¼Œå¯å¹¶è¡Œæˆ–é¡ºåºå¤„ç†
- **å®Œæ•´ç»Ÿè®¡**: å®æ—¶ç»Ÿè®¡ä¿¡æ¯ï¼Œæ”¯æŒJSONå¯¼å‡º

---

## æ ¸å¿ƒåŠŸèƒ½

### 1ï¸âƒ£ ä¼šè¯ç®¡ç†

#### ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºä¼šè¯ â†’ è¿è¡Œä¸­ â†’ æš‚åœ/å´©æºƒ/å®Œæˆ
           â†“         â†“
         æ¢å¤ â†â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¼šè¯çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ | å¯æ¢å¤ |
|------|------|--------|
| `running` | æ­£åœ¨è¿è¡Œ | âœ… |
| `paused` | å·²æš‚åœ | âœ… |
| `crashed` | å¼‚å¸¸ä¸­æ–­ | âœ… |
| `completed` | å·²å®Œæˆ | âŒ |
| `cancelled` | å·²å–æ¶ˆ | âŒ |

### 2ï¸âƒ£ æ–‡ä»¶è®°å½•

#### æ–‡ä»¶çŠ¶æ€

| çŠ¶æ€ | è¯´æ˜ | ä¸‹æ¬¡å¤„ç† |
|------|------|---------|
| `pending` | å¾…å¤„ç† | âœ… å¤„ç† |
| `processing` | å¤„ç†ä¸­ | âœ… é‡è¯• |
| `completed` | å·²å®Œæˆ | âŒ è·³è¿‡ |
| `failed` | å·²å¤±è´¥ | âš ï¸ å¯é€‰ |
| `skipped` | å·²è·³è¿‡ | âŒ è·³è¿‡ |

#### è®°å½•ä¿¡æ¯

æ¯ä¸ªæ–‡ä»¶è®°å½•åŒ…å«ï¼š
- æ–‡ä»¶è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„+ç›¸å¯¹è·¯å¾„ï¼‰
- å¤„ç†çŠ¶æ€
- æ—¶é—´ä¿¡æ¯ï¼ˆå¼€å§‹/ç»“æŸ/è€—æ—¶ï¼‰
- å¤§å°ä¿¡æ¯ï¼ˆåŸå§‹/æ–°/èŠ‚çœï¼‰
- æ ¼å¼ä¿¡æ¯ï¼ˆæºæ ¼å¼/ç›®æ ‡æ ¼å¼ï¼‰
- é”™è¯¯ä¿¡æ¯ï¼ˆå¤±è´¥åŸå› ï¼‰
- é‡è¯•æ¬¡æ•°

### 3ï¸âƒ£ ç»Ÿè®¡ä¿¡æ¯

å®æ—¶ç»Ÿè®¡åŒ…æ‹¬ï¼š
- æ€»æ–‡ä»¶æ•° / å·²å¤„ç† / å·²å®Œæˆ / å¤±è´¥ / è·³è¿‡
- æ€»å¤§å°ï¼ˆå¤„ç†å‰/å¤„ç†å/èŠ‚çœï¼‰
- èŠ‚çœç™¾åˆ†æ¯”
- å¹³å‡å¤„ç†æ—¶é—´

---

## æ¶æ„è®¾è®¡

### æ¨¡å—ç»“æ„

```
pkg/checkpoint/
â”œâ”€â”€ types.go          # æ•°æ®ç»“æ„å®šä¹‰ï¼ˆ100è¡Œï¼‰
â”œâ”€â”€ boltdb.go         # BoltDBæ“ä½œå±‚ï¼ˆ240è¡Œï¼‰
â”œâ”€â”€ manager.go        # æ–­ç‚¹ç®¡ç†å™¨ï¼ˆ340è¡Œï¼‰
â”œâ”€â”€ session.go        # ä¼šè¯ç®¡ç†å™¨ï¼ˆ165è¡Œï¼‰
â”œâ”€â”€ example_usage.go  # ä½¿ç”¨ç¤ºä¾‹ï¼ˆ100è¡Œï¼‰
â””â”€â”€ go.mod            # æ¨¡å—å®šä¹‰
```

**æ€»ä»£ç **: ~945è¡Œ

### æ•°æ®å­˜å‚¨

#### BoltDB Buckets

```
pixly_sessions.db
â”œâ”€â”€ sessions          # ä¼šè¯ä¿¡æ¯
â”‚   â”œâ”€â”€ session_xxx   â†’ SessionInfo JSON
â”‚   â””â”€â”€ session_yyy   â†’ SessionInfo JSON
â”œâ”€â”€ files             # æ–‡ä»¶è®°å½•
â”‚   â”œâ”€â”€ session_xxx:file1 â†’ FileRecord JSON
â”‚   â”œâ”€â”€ session_xxx:file2 â†’ FileRecord JSON
â”‚   â””â”€â”€ session_yyy:file1 â†’ FileRecord JSON
â””â”€â”€ statistics        # ç»Ÿè®¡ä¿¡æ¯
    â”œâ”€â”€ session_xxx   â†’ Statistics JSON
    â””â”€â”€ session_yyy   â†’ Statistics JSON
```

### å¹¶å‘å®‰å…¨

- ä½¿ç”¨`sync.RWMutex`ä¿æŠ¤å†…å­˜æ•°æ®
- BoltDBåŸç”Ÿæ”¯æŒACIDäº‹åŠ¡
- è¯»å†™é”åˆ†ç¦»ï¼Œæé«˜å¹¶å‘æ€§èƒ½

---

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹

#### 1. åˆ›å»ºæ–°ä¼šè¯

```go
import "pixly/pkg/checkpoint"

// åˆ›å»ºç®¡ç†å™¨
manager, err := checkpoint.NewManager("pixly_sessions.db", 10)
if err != nil {
    log.Fatal(err)
}
defer manager.Close()

// åˆ›å»ºä¼šè¯
sessionID := "session_20250125_001"
err = manager.CreateSession(
    sessionID,
    "/path/to/images",  // æºç›®å½•
    "/path/to/output",  // è¾“å‡ºç›®å½•
    "auto",             // æ¨¡å¼
    false,              // æ˜¯å¦åŸåœ°è½¬æ¢
)

// è®¾ç½®æ€»æ–‡ä»¶æ•°
manager.SetTotalFiles(1000)
```

#### 2. è®°å½•å¤„ç†è¿›åº¦

```go
// å¤„ç†æ–‡ä»¶
for _, filePath := range files {
    // è®°å½•å¼€å§‹
    manager.RecordFileStart(filePath)
    
    // æ‰§è¡Œè½¬æ¢
    outputPath, originalSize, newSize, err := convertFile(filePath)
    
    if err != nil {
        // è®°å½•å¤±è´¥
        manager.RecordFileFailed(filePath, err.Error())
        continue
    }
    
    // è®°å½•æˆåŠŸ
    manager.RecordFileComplete(
        filePath,
        outputPath,
        originalSize,
        newSize,
        "jxl",     // æ–¹æ³•
        "jpg",     // æºæ ¼å¼
        "jxl",     // ç›®æ ‡æ ¼å¼
    )
}

// å®Œæˆä¼šè¯
manager.CompleteSession()
```

#### 3. æ¢å¤ä¸­æ–­ä¼šè¯

```go
// åˆ›å»ºä¼šè¯ç®¡ç†å™¨
sm, err := checkpoint.NewSessionManager("pixly_sessions.db")
if err != nil {
    log.Fatal(err)
}
defer sm.Close()

// æŸ¥æ‰¾æœªå®Œæˆä¼šè¯
incomplete, err := sm.ListIncompleteSessions()
if err != nil {
    log.Fatal(err)
}

for _, session := range incomplete {
    fmt.Println(sm.GetSessionSummary(session))
}

// æ¢å¤ç‰¹å®šä¼šè¯
manager := sm.GetManager()
err = manager.LoadSession("session_20250125_001")

// è·å–å·²å¤„ç†æ–‡ä»¶åˆ—è¡¨
processed, err := manager.GetProcessedFiles("session_20250125_001")

// è¿‡æ»¤æœªå¤„ç†æ–‡ä»¶
remaining := filterUnprocessed(allFiles, processed)

// ç»§ç»­å¤„ç†
for _, filePath := range remaining {
    // ... å¤„ç†é€»è¾‘
}
```

### é›†æˆåˆ°Pixlyä¸»ç¨‹åº

#### åˆå§‹åŒ–

```go
// cmd/pixly/main.go

var (
    checkpointManager *checkpoint.Manager
    sessionID         string
)

func initCheckpoint() error {
    dbPath := filepath.Join(os.UserHomeDir(), ".pixly", "sessions.db")
    
    manager, err := checkpoint.NewManager(dbPath, 10)
    if err != nil {
        return err
    }
    
    checkpointManager = manager
    sessionID = fmt.Sprintf("session_%d", time.Now().Unix())
    
    return checkpointManager.CreateSession(
        sessionID,
        targetDir,
        outputDir,
        mode,
        inPlace,
    )
}
```

#### é›†æˆåˆ°å¤„ç†æµç¨‹

```go
// pkg/processor/processor.go

func (p *Processor) ProcessFile(filePath string) error {
    // è®°å½•å¼€å§‹
    if p.checkpointManager != nil {
        p.checkpointManager.RecordFileStart(filePath)
    }
    
    // å¤„ç†æ–‡ä»¶
    result, err := p.convert(filePath)
    
    // è®°å½•ç»“æœ
    if p.checkpointManager != nil {
        if err != nil {
            p.checkpointManager.RecordFileFailed(filePath, err.Error())
        } else {
            p.checkpointManager.RecordFileComplete(
                filePath,
                result.OutputPath,
                result.OriginalSize,
                result.NewSize,
                result.Method,
                result.SourceFormat,
                result.TargetFormat,
            )
        }
    }
    
    return err
}
```

#### å¯åŠ¨æ—¶æ£€æŸ¥

```go
func checkForIncompleteSession() {
    sm, err := checkpoint.NewSessionManager(dbPath)
    if err != nil {
        return
    }
    defer sm.Close()
    
    incomplete, err := sm.FindIncompleteSession(targetDir)
    if err != nil || incomplete == nil {
        return
    }
    
    // è¯¢é—®ç”¨æˆ·æ˜¯å¦æ¢å¤
    fmt.Printf("å‘ç°æœªå®Œæˆçš„ä¼šè¯:\n")
    fmt.Println(sm.GetSessionSummary(incomplete))
    fmt.Print("æ˜¯å¦æ¢å¤? (y/n): ")
    
    var response string
    fmt.Scanln(&response)
    
    if strings.ToLower(response) == "y" {
        resumeSession(incomplete.SessionID)
    }
}
```

---

## APIå‚è€ƒ

### Manager

#### æ ¸å¿ƒæ–¹æ³•

```go
// åˆ›å»ºç®¡ç†å™¨
func NewManager(dbPath string, saveInterval int) (*Manager, error)

// ä¼šè¯ç®¡ç†
func (m *Manager) CreateSession(sessionID, targetDir, outputDir, mode string, inPlace bool) error
func (m *Manager) LoadSession(sessionID string) error
func (m *Manager) CompleteSession() error
func (m *Manager) SetTotalFiles(total int) error

// æ–‡ä»¶è®°å½•
func (m *Manager) RecordFileStart(filePath string) error
func (m *Manager) RecordFileComplete(filePath, outputPath string, originalSize, newSize int64, method, format, targetFormat string) error
func (m *Manager) RecordFileFailed(filePath, errorMsg string) error
func (m *Manager) RecordFileSkipped(filePath, reason string) error

// æŸ¥è¯¢
func (m *Manager) GetProcessedFiles(sessionID string) ([]string, error)
func (m *Manager) GetCurrentSession() *SessionInfo
func (m *Manager) GetCurrentStats() *Statistics

// ä¿å­˜å’Œæ¸…ç†
func (m *Manager) Save() error
func (m *Manager) DeleteSession(sessionID string) error
func (m *Manager) Close() error
```

### SessionManager

#### é«˜çº§ç®¡ç†æ–¹æ³•

```go
// åˆ›å»ºä¼šè¯ç®¡ç†å™¨
func NewSessionManager(dbPath string) (*SessionManager, error)

// ä¼šè¯æŸ¥è¯¢
func (sm *SessionManager) FindIncompleteSession(targetDir string) (*SessionInfo, error)
func (sm *SessionManager) ListIncompleteSessions() ([]*SessionInfo, error)
func (sm *SessionManager) ListCompletedSessions() ([]*SessionInfo, error)

// ä¼šè¯ç®¡ç†
func (sm *SessionManager) CleanupOldSessions(olderThan time.Duration) (int, error)
func (sm *SessionManager) GetSessionProgress(session *SessionInfo) float64
func (sm *SessionManager) GetSessionSummary(session *SessionInfo) string

// è·å–åº•å±‚ç®¡ç†å™¨
func (sm *SessionManager) GetManager() *Manager
```

---

## æœ€ä½³å®è·µ

### 1. ä¼šè¯IDå‘½å

```go
// âœ… æ¨èï¼šä½¿ç”¨æ—¶é—´æˆ³+æè¿°
sessionID := fmt.Sprintf("session_%s_%s", 
    time.Now().Format("20060102_150405"),
    "batch_photos")

// âŒ ä¸æ¨èï¼šä½¿ç”¨éšæœºå­—ç¬¦ä¸²
sessionID := uuid.New().String()
```

### 2. ä¿å­˜é—´éš”

```go
// âœ… æ¨èï¼š10-50ä¸ªæ–‡ä»¶ä¿å­˜ä¸€æ¬¡
manager := checkpoint.NewManager(dbPath, 10)

// âŒ ä¸æ¨èï¼šå¤ªé¢‘ç¹ï¼ˆæ€§èƒ½å·®ï¼‰
manager := checkpoint.NewManager(dbPath, 1)

// âŒ ä¸æ¨èï¼šå¤ªå°‘ï¼ˆä¸¢å¤±é£é™©ï¼‰
manager := checkpoint.NewManager(dbPath, 1000)
```

### 3. é”™è¯¯å¤„ç†

```go
// âœ… æ¨èï¼šè¯¦ç»†è®°å½•é”™è¯¯
if err != nil {
    checkpointManager.RecordFileFailed(
        filePath,
        fmt.Sprintf("è½¬æ¢å¤±è´¥: %v (é‡è¯•: %d)", err, retryCount),
    )
}

// âŒ ä¸æ¨èï¼šä¸¢å¼ƒé”™è¯¯ä¿¡æ¯
checkpointManager.RecordFileFailed(filePath, "failed")
```

### 4. å®šæœŸæ¸…ç†

```go
// âœ… æ¨èï¼šæ¯æ¬¡å¯åŠ¨æ—¶æ¸…ç†æ—§ä¼šè¯
sm, _ := checkpoint.NewSessionManager(dbPath)
sm.CleanupOldSessions(30 * 24 * time.Hour) // 30å¤©
```

### 5. ä¼˜é›…å…³é—­

```go
// âœ… æ¨èï¼šä½¿ç”¨deferç¡®ä¿å…³é—­
manager, err := checkpoint.NewManager(dbPath, 10)
if err != nil {
    return err
}
defer manager.Close()

// åœ¨é€€å‡ºå‰ä¿å­˜
c := make(chan os.Signal, 1)
signal.Notify(c, os.Interrupt, syscall.SIGTERM)
go func() {
    <-c
    manager.Save()
    manager.CompleteSession()
    os.Exit(0)
}()
```

---

## æ€§èƒ½ä¼˜åŒ–

### å†…å­˜ä½¿ç”¨

- BoltDBä½¿ç”¨mmapï¼Œå†…å­˜å ç”¨å°
- ä¼šè¯ä¿¡æ¯ä»…ä¿ç•™å½“å‰ä¼šè¯åœ¨å†…å­˜
- æ–‡ä»¶è®°å½•æŒ‰éœ€åŠ è½½

### ç£ç›˜IO

- æ‰¹é‡å†™å…¥ï¼ˆæ¯Nä¸ªæ–‡ä»¶ä¸€æ¬¡ï¼‰
- ä½¿ç”¨äº‹åŠ¡å‡å°‘ç£ç›˜åŒæ­¥
- æ”¯æŒè‡ªå®šä¹‰ä¿å­˜é—´éš”

### å¹¶å‘å®‰å…¨

- è¯»å†™é”åˆ†ç¦»
- äº‹åŠ¡éš”ç¦»
- æ— ç«äº‰æ¡ä»¶

---

## æ•…éšœæ¢å¤

### å´©æºƒæ£€æµ‹

```go
sessions, _ := sm.ListIncompleteSessions()
for _, session := range sessions {
    // æ£€æŸ¥æœ€åæ›´æ–°æ—¶é—´
    if time.Since(session.LastUpdate) > 1*time.Hour {
        // å¯èƒ½å´©æºƒ
        session.Status = SessionCrashed
    }
}
```

### è‡ªåŠ¨æ¢å¤

```go
// æ¢å¤å´©æºƒä¼šè¯
func resumeCrashedSessions() {
    sm, _ := checkpoint.NewSessionManager(dbPath)
    incomplete, _ := sm.ListIncompleteSessions()
    
    for _, session := range incomplete {
        if session.Status == SessionCrashed {
            fmt.Printf("æ£€æµ‹åˆ°å´©æºƒä¼šè¯: %s\n", session.SessionID)
            fmt.Printf("è¿›åº¦: %d/%d\n", session.Processed, session.TotalFiles)
            
            // è‡ªåŠ¨æ¢å¤æˆ–è¯¢é—®ç”¨æˆ·
        }
    }
}
```

---

## FAQ

### Q: BoltDBæ–‡ä»¶ä¼šå˜å¤šå¤§ï¼Ÿ

A: æ¯ä¸ªä¼šè¯çº¦å ç”¨ï¼š
- ä¼šè¯ä¿¡æ¯: ~1KB
- æ¯ä¸ªæ–‡ä»¶è®°å½•: ~500 bytes
- 1000ä¸ªæ–‡ä»¶çº¦ 500KB

å»ºè®®å®šæœŸæ¸…ç†å®Œæˆçš„ä¼šè¯ã€‚

### Q: æ”¯æŒå¤šä¸ªPixlyå®ä¾‹åŒæ—¶è¿è¡Œå—ï¼Ÿ

A: æ”¯æŒï¼Œä½†éœ€è¦ï¼š
- ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“æ–‡ä»¶
- æˆ–å¤„ç†ä¸åŒçš„ç›®å½•
- BoltDBä¸æ”¯æŒå¤šè¿›ç¨‹å†™å…¥åŒä¸€æ–‡ä»¶

### Q: å¦‚ä½•è¿ç§»æ—§çš„JSONæ£€æŸ¥ç‚¹ï¼Ÿ

A: æä¾›è¿ç§»å·¥å…·ï¼š

```go
func migrateFromJSON(jsonPath, dbPath string) error {
    // è¯»å–JSON
    data, _ := os.ReadFile(jsonPath)
    var oldCheckpoint OldFormat
    json.Unmarshal(data, &oldCheckpoint)
    
    // å†™å…¥BoltDB
    manager, _ := checkpoint.NewManager(dbPath, 10)
    // ... è½¬æ¢æ•°æ®
}
```

### Q: æ€§èƒ½å½±å“å¤šå¤§ï¼Ÿ

A: å‡ ä¹æ²¡æœ‰ï¼š
- æ¯10ä¸ªæ–‡ä»¶ä¸€æ¬¡å†™å…¥ï¼š<1ms
- æŸ¥è¯¢å·²å¤„ç†æ–‡ä»¶ï¼š<5ms
- æ€»ä½“å¼€é”€ï¼š<0.1%

---

## æ€»ç»“

BoltDBæ–­ç‚¹ç»­ä¼ ç³»ç»Ÿæä¾›ï¼š

âœ… **å¯é æ€§**: ACIDäº‹åŠ¡ï¼Œæ•°æ®å®‰å…¨  
âœ… **é«˜æ•ˆ**: æ‰¹é‡ä¿å­˜ï¼Œä½å¼€é”€  
âœ… **æ˜“ç”¨**: ç®€æ´APIï¼Œæ¸…æ™°æ–‡æ¡£  
âœ… **çµæ´»**: å¤šä¼šè¯ï¼Œå¯æ¢å¤  
âœ… **å®Œæ•´**: è¯¦ç»†ç»Ÿè®¡ï¼Œå…¨é¢è®°å½•

---

**ç‰ˆæœ¬**: v4.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-25  
**ä½œè€…**: Pixly Team
