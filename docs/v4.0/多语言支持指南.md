# Pixly v4.0 - 多语言支持系统指南

**版本**: v4.0  
**创建日期**: 2025-10-25  
**状态**: ✅ 已完成

---

## 📋 目录

1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [核心功能](#核心功能)
4. [使用指南](#使用指南)
5. [API参考](#api参考)
6. [最佳实践](#最佳实践)

---

## 系统概述

### 🎯 目标

为Pixly提供完整的多语言支持，支持简体中文和English双语界面，提升国际用户体验。

### ✨ 特性

- **双语支持**: 简体中文（zh-CN）和English（en-US）
- **自动检测**: 根据系统环境自动选择语言
- **动态切换**: 运行时无需重启即可切换语言
- **占位符支持**: 支持{0}, {1}等参数占位符
- **回退机制**: 翻译缺失时自动回退到默认语言
- **易于扩展**: 便于添加新语言包

---

## 快速开始

### 基础使用

```go
import "pixly/pkg/i18n"

// 初始化（自动检测系统语言）
func main() {
    i18n.Init(i18n.ZhCN)
    
    // 翻译消息
    fmt.Println(i18n.T(i18n.MsgWelcome))
    // 输出: 欢迎使用Pixly图像转换工具
    
    // 带参数的翻译
    fmt.Println(i18n.T(i18n.MsgProgress, "75%"))
    // 输出: 进度: 75%
}
```

### 自动检测语言

```go
// 创建管理器（自动检测系统语言）
mgr := i18n.NewManager()
locale := mgr.AutoDetectAndSet()

fmt.Printf("Detected locale: %s\n", locale)
fmt.Println(mgr.T(i18n.MsgWelcome))
```

### 手动切换语言

```go
// 切换到英文
i18n.SetLocale(i18n.EnUS)
fmt.Println(i18n.T(i18n.MsgWelcome))
// 输出: Welcome to Pixly Image Converter

// 切换到中文
i18n.SetLocale(i18n.ZhCN)
fmt.Println(i18n.T(i18n.MsgWelcome))
// 输出: 欢迎使用Pixly图像转换工具
```

---

## 核心功能

### 1️⃣ 语言自动检测

检测优先级：
1. 环境变量 `PIXLY_LANG`
2. 环境变量 `LANG`
3. 环境变量 `LC_ALL`
4. 默认值（zh-CN）

```bash
# 通过环境变量设置语言
export PIXLY_LANG=en-US
./pixly convert images/

# 或
export LANG=zh_CN.UTF-8
./pixly convert images/
```

### 2️⃣ 消息分类

#### 通用消息
- 欢迎、启动、完成、进度等

#### 文件操作
- 扫描文件、处理文件、文件完成/失败/跳过

#### 转换相关
- 转换开始/完成、空间节省、质量分析

#### 会话管理
- 创建/加载/完成/恢复会话

#### 错误消息
- 文件不存在、权限不足、磁盘满、格式无效等

#### 统计信息
- 总文件数、已处理、成功、失败、跳过等

### 3️⃣ 占位符替换

支持 `{0}`, `{1}`, ... `{n}` 占位符：

```go
// 单个参数
i18n.T(i18n.MsgProcessingFile, "photo.jpg")
// 中文: 正在处理: photo.jpg
// 英文: Processing: photo.jpg

// 多个参数
i18n.T(i18n.MsgSpaceSaved, "65", "10MB", "3.5MB")
// 中文: 节省空间: 65% (10MB → 3.5MB)
// 英文: Space saved: 65% (10MB → 3.5MB)
```

---

## 使用指南

### CLI集成

#### 添加语言参数

```go
// main.go
import (
    "flag"
    "pixly/pkg/i18n"
)

var (
    langFlag = flag.String("lang", "", "Interface language (zh-CN, en-US)")
)

func main() {
    flag.Parse()
    
    // 设置语言
    var locale i18n.Locale
    if *langFlag != "" {
        locale = i18n.ParseLocaleString(*langFlag)
    } else {
        // 自动检测
        mgr := i18n.NewManager()
        locale = mgr.AutoDetectAndSet()
    }
    
    i18n.Init(locale)
    
    // 使用翻译
    fmt.Println(i18n.T(i18n.MsgWelcome))
}
```

#### 命令行使用

```bash
# 使用中文（自动检测）
./pixly convert images/

# 明确指定英文
./pixly convert images/ --lang en-US

# 明确指定中文
./pixly convert images/ --lang zh-CN
```

### 配置文件集成

```go
// 在配置中添加语言选项
type Config struct {
    Language string `yaml:"language"`
}

func loadConfig(path string) (*Config, error) {
    // 读取配置...
    config := &Config{}
    
    // 设置语言
    if config.Language != "" {
        locale := i18n.ParseLocaleString(config.Language)
        if i18n.IsValidLocale(locale) {
            i18n.SetLocale(locale)
        }
    }
    
    return config, nil
}
```

### 交互式UI

```go
func interactiveMode() {
    // 显示横幅
    fmt.Println("╔═══════════════════════════════════════╗")
    fmt.Println("║                                       ║")
    fmt.Printf("║   %s   ║\n", i18n.T(MsgWelcome))
    fmt.Println("║                                       ║")
    fmt.Println("╚═══════════════════════════════════════╝")
    
    // 提示
    fmt.Println(i18n.T("hint.drag_drop"))
    fmt.Println(i18n.T("hint.ctrl_c"))
    
    // 询问用户
    fmt.Print(i18n.T("confirm.continue"))
    
    var response string
    fmt.Scanln(&response)
}
```

### 进度显示

```go
func showProgress(current, total int, fileName string) {
    percent := float64(current) / float64(total) * 100
    
    // 显示文件处理
    fmt.Println(i18n.T(i18n.MsgProcessingFile, fileName))
    
    // 显示进度
    fmt.Println(i18n.T(i18n.MsgProgress, 
        fmt.Sprintf("%.1f%%", percent)))
}
```

### 错误处理

```go
func handleError(err error, filePath string) {
    var msg string
    
    if os.IsNotExist(err) {
        msg = i18n.T(i18n.ErrFileNotFound, filePath)
    } else if os.IsPermission(err) {
        msg = i18n.T(i18n.ErrPermissionDenied, filePath)
    } else {
        msg = i18n.T(i18n.ErrConversionFailed, err.Error())
    }
    
    fmt.Println(msg)
}
```

---

## API参考

### 核心函数

```go
// 初始化（设置默认语言）
func Init(locale Locale)

// 翻译消息
func T(key string, args ...interface{}) string

// 设置语言
func SetLocale(locale Locale)

// 获取当前语言
func GetLocale() Locale

// 获取翻译器
func GetTranslator() *Translator
```

### Manager

```go
// 创建管理器（自动检测语言）
func NewManager() *Manager

// 自动检测并设置语言
func (m *Manager) AutoDetectAndSet() Locale

// 设置语言
func (m *Manager) SetLocale(locale Locale)

// 获取当前语言
func (m *Manager) GetLocale() Locale

// 翻译消息
func (m *Manager) T(key string, args ...interface{}) string
```

### Translator

```go
// 创建翻译器
func NewTranslator(locale Locale) *Translator

// 加载语言包
func (t *Translator) LoadMessages(locale Locale, messages map[string]string)

// 设置语言
func (t *Translator) SetLocale(locale Locale)

// 翻译消息
func (t *Translator) T(key string, args ...interface{}) string
```

### 工具函数

```go
// 解析语言字符串
func ParseLocaleString(s string) Locale

// 获取所有可用语言
func GetAvailableLocales() []Locale

// 检查语言是否有效
func IsValidLocale(locale Locale) bool
```

### 常量

```go
// 语言代码
const (
    ZhCN Locale = "zh-CN" // 简体中文
    EnUS Locale = "en-US" // English
)

// 消息键（部分列表）
const (
    MsgWelcome          = "msg.welcome"
    MsgStarting         = "msg.starting"
    MsgCompleted        = "msg.completed"
    MsgProcessingFile   = "msg.processing_file"
    MsgFileCompleted    = "msg.file_completed"
    ErrFileNotFound     = "err.file_not_found"
    ErrPermissionDenied = "err.permission_denied"
    StatTotalFiles      = "stat.total_files"
    StatProcessed       = "stat.processed"
    // ... 更多
)
```

---

## 最佳实践

### 1. 消息键命名规范

```go
// ✅ 推荐：使用有意义的分类前缀
const (
    MsgWelcome      = "msg.welcome"      // 消息
    ErrFileNotFound = "err.file_not_found" // 错误
    StatTotalFiles  = "stat.total_files"  // 统计
    CfgLanguage     = "cfg.language"      // 配置
)

// ❌ 不推荐：无意义的命名
const (
    Key1 = "k1"
    Key2 = "k2"
)
```

### 2. 占位符使用

```go
// ✅ 推荐：使用数字占位符
i18n.T("msg.conversion", "jpg", "jxl")
// 中文: "转换 {0} 到 {1}"
// 英文: "Converting {0} to {1}"

// ❌ 不推荐：使用命名占位符（不支持）
// "Converting {source} to {target}" // 不支持
```

### 3. 翻译一致性

```go
// ✅ 推荐：所有用户可见文本都使用翻译
fmt.Println(i18n.T(i18n.MsgWelcome))
fmt.Println(i18n.T(i18n.MsgProgress, "75%"))

// ❌ 不推荐：硬编码文本
fmt.Println("Welcome to Pixly")
fmt.Println("Progress: 75%")
```

### 4. 默认语言

```go
// ✅ 推荐：总是初始化默认语言
func main() {
    // 自动检测或使用默认
    mgr := i18n.NewManager()
    mgr.AutoDetectAndSet()
    
    // 其他代码...
}

// ❌ 不推荐：不初始化（会使用内部默认）
func main() {
    // 直接使用，可能出现意外
    fmt.Println(i18n.T(i18n.MsgWelcome))
}
```

### 5. 错误消息国际化

```go
// ✅ 推荐：所有错误消息都翻译
return fmt.Errorf(i18n.T(i18n.ErrFileNotFound, path))

// ❌ 不推荐：英文硬编码错误
return fmt.Errorf("file not found: %s", path)
```

---

## 扩展新语言

### 添加新语言包

```go
// 1. 添加语言常量
const (
    JaJP Locale = "ja-JP" // 日本語
)

// 2. 创建语言包函数
func getJaJPMessages() map[string]string {
    return map[string]string{
        MsgWelcome: "Pixlyへようこそ",
        // ... 更多翻译
    }
}

// 3. 在NewTranslator中加载
func NewTranslator(locale Locale) *Translator {
    // ... existing code ...
    t.LoadMessages(JaJP, getJaJPMessages())
    return t
}

// 4. 更新parseLocale
func parseLocale(lang string) Locale {
    // ... existing code ...
    
    if strings.Contains(lang, "ja") ||
       strings.Contains(lang, "japanese") {
        return JaJP
    }
    
    return ZhCN
}
```

---

## 性能考虑

### 翻译性能

- 翻译查找: O(1)（哈希表）
- 占位符替换: O(n)（n为参数数量）
- 语言切换: O(1)

### 内存使用

- 每个语言包: ~50KB
- 两个语言包总计: ~100KB
- 可忽略的内存开销

---

## FAQ

### Q: 如何添加新的翻译字符串？

A: 
1. 在 `i18n.go` 中添加常量
2. 在 `locale_zh.go` 中添加中文翻译
3. 在 `locale_en.go` 中添加英文翻译

### Q: 翻译缺失会怎样？

A: 返回消息键本身，不会崩溃。

### Q: 支持运行时切换语言吗？

A: 支持，调用 `SetLocale()` 即可。

### Q: 如何检测用户的系统语言？

A: 使用 `NewManager()` 会自动检测。

### Q: 性能影响大吗？

A: 几乎没有，单次翻译 <1μs。

---

## 总结

多语言支持系统提供：

✅ **双语界面**: 中文和英文  
✅ **自动检测**: 智能语言识别  
✅ **易于使用**: 简洁的API  
✅ **易于扩展**: 便于添加新语言  
✅ **高性能**: 零开销翻译  

---

**版本**: v4.0  
**更新日期**: 2025-10-25  
**作者**: Pixly Team
