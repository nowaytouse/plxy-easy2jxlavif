# 动态图片转AVIF工具 - 处理流程技术文档

## 概述

本文档详细介绍了动态图片转AVIF工具的内部处理流程，帮助技术用户理解程序的运行机制和各个组件的工作原理。

## 程序架构

### 核心组件

1. **主控制器 (main.go)**
   - 程序入口点和整体流程控制
   - 命令行参数解析和配置管理
   - 线程池初始化和任务调度

2. **文件处理引擎 (processFile)**
   - 单个文件的完整处理流程
   - 文件类型识别和验证
   - 转换、验证、元数据处理的协调

3. **图像转换器 (convertToAvifWithOpts)**
   - 调用 ffmpeg 工具进行格式转换
   - 根据图像类型选择最优转换策略
   - 动画检测和针对性处理

4. **验证系统 (isAnimatedImage)**
   - 动画检测算法
   - 像素级精度检查
   - 动画帧数一致性验证

## 处理流程详解

### 1. 初始化阶段

```
🚀 程序启动
├── 命令行参数解析
├── 日志系统初始化
├── 信号处理注册
└── 目录存在性检查
```

**启动流程：**
- 解析命令行参数
- 初始化日志系统，同时输出到控制台和日志文件
- 注册信号处理函数以实现优雅退出
- 检查输入和输出目录的有效性

### 2. 文件扫描阶段

```
📂 文件扫描
├── 目录遍历 (godirwalk)
├── 文件类型识别 (filetype)
├── 支持格式验证
└── 动画检测 (针对支持的格式)
```

**扫描策略：**
- 使用 `godirwalk` 进行高效的目录遍历
- 实时过滤不支持的文件类型
- 支持试运行模式，只打印将要处理的文件

### 3. 并行处理阶段

```
⚡ 并行处理
├── 线程池任务分配
├── 信号处理（优雅中断）
├── 进度监控和报告
└── 错误处理和重试机制
```

**并发控制：**
- 使用 `ants` 库管理线程池
- 进程级和文件句柄级的并发限制
- 支持 SIGINT/SIGTERM 信号的优雅处理

### 4. 单个文件处理流程

#### 4.1 文件预处理

```
📂 文件预处理
├── 打开文件和权限检查
├── 文件类型识别 (filetype 库)
├── 支持格式验证
└── 动画检测 (针对支持的格式)
```

**类型识别：**
- 支持格式：GIF, WebP, APNG
- 动画检测：GIF, WebP, APNG
- 实时动画帧数检测和首帧验证

#### 4.2 转换执行

```
🔄 转换执行
├── 动画状态检测
├── 转换策略选择
├── ffmpeg 命令构建
├── 超时控制和重试
└── 转换结果验证
```

**转换策略：**
- GIF/WebP/APNG: 高质量转换 (`libsvtav1` 编码器)
- 根据质量参数调整CRF值
- 根据速度参数调整编码预设

#### 4.3 质量验证

```
🔍 质量验证
├── 文件存在性检查
├── 文件大小对比
└── 格式有效性验证
```

**验证机制：**
- 检查输出文件是否存在
- 对比输入和输出文件大小
- 验证AVIF文件格式有效性

#### 4.4 文件输出

```
📁 文件输出
├── 输出目录创建
├── 文件重命名
└── 时间戳校准
```

### 5. 统计和报告阶段

```
📊 统计报告
├── 详细处理日志收集
├── 按格式分类统计
├── 性能分析（处理时间、压缩率）
├── 错误汇总和原因分析
└── 用户友好的摘要输出
```

## 关键技术特性

### 动画检测算法

1. **GIF 动画检测**
   ```go
   g, err := gif.DecodeAll(file)
   return len(g.Image) > 1, nil
   ```

2. **APNG 动画检测**
   - 查找 PNG 文件中的 `acTL` chunk
   - 检测动画控制块的存在

3. **WebP 动画检测**
   - 查找 RIFF 容器中的 `ANIM` chunk
   - 验证动画标识符

### 性能优化策略

1. **智能线程配置**
   - 根据 CPU 核心数动态调整
   - 避免过度并发导致的系统卡顿
   - 资源限制保护机制

2. **内存管理**
   - 预分配线程池
   - 及时释放临时文件
   - 流式处理大文件

3. **并发控制**
   - 进程级并发限制
   - 文件句柄限制
   - 信号量机制

### 错误处理和恢复

1. **重试机制**
   - 可配置的重试次数
   - 指数退避策略
   - 失败原因记录

2. **超时保护**
   - 单个文件转换超时：2分钟
   - 进程级超时控制

3. **优雅退出**
   - 支持 SIGINT/SIGTERM 信号
   - 正在处理的文件完成后再退出
   - 资源清理和状态保存

## 命令行接口

### 基本用法
```bash
dynamic2avif -input <输入目录> -output <输出目录> [选项]
```

### 选项参数

| 选项 | 默认值 | 说明 |
|------|--------|------|
| `-workers` | CPU核心数 | 并发工作线程数 |
| `-quality` | 50 | AVIF质量 (0-100) |
| `-speed` | 6 | 编码速度 (0-10) |
| `-skip-exist` | false | 跳过已存在的文件 |
| `-dry-run` | false | 试运行模式 |
| `-timeout` | 120 | 单个文件处理超时秒数 |
| `-retries` | 2 | 失败重试次数 |

## 技术细节

### FFmpeg转换参数

- 编码器: `libsvtav1`
- CRF计算: `50 - quality/2`
- 像素格式: `yuv420p`
- 预设: 根据speed参数调整

### AVIF格式优势

1. **高压缩率:** 相比GIF/WebP具有更高的压缩率
2. **现代特性支持:** 支持HDR、宽色域、透明度、动画等现代特性
3. **广泛兼容性:** 现代浏览器和设备都支持AVIF格式

## 故障排除

### 常见问题

1. **"command not found: ffmpeg"**
   - 确保FFmpeg已正确安装并在PATH中

2. **转换速度慢**
   - 降低speed参数值（0-3）
   - 减少workers参数值
   - 检查系统资源使用情况

3. **内存不足**
   - 减少workers参数值
   - 降低quality参数值

### 支持的文件格式

- **GIF**: .gif (包括动画)
- **WebP**: .webp (包括动画)
- **APNG**: .png (包含动画的PNG)

## 性能基准

### 硬件适配
- **CPU密集型任务**：建议使用speed 4-6获得最佳压缩比
- **内存受限环境**：降低workers参数避免内存溢出
- **存储I/O瓶颈**：使用SSD存储提升读写性能

关键优势：
- 🎯 高质量转换保证
- ⚡ 高性能并行处理
- 🔍 详细的处理透明度
- 🛡️ 健壮的错误处理
- 📊 全面的统计分析
- 🎨 用户友好的界面