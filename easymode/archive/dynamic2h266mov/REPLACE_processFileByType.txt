// è¿™æ˜¯è¦æ›¿æ¢åˆ°main.goä¸­çš„processFileByTypeå‡½æ•°ï¼ˆH.266ä¸“ç”¨ç‰ˆæœ¬ï¼‰

func processFileByType(filePath string, opts Options) (string, string, string, error) {
	// åŠ¨æ€å›¾ç‰‡è½¬H.266/VVCç¼–ç MOVçš„å®é™…è½¬æ¢é€»è¾‘
	outputPath := strings.TrimSuffix(filePath, filepath.Ext(filePath)) + ".mov"
	conversionMode := "åŠ¨å›¾è½¬H.266ç¼–ç MOV"

	// âœ… æ­¥éª¤1: æ•è·æºæ–‡ä»¶çš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ï¼ˆåœ¨è½¬æ¢ä¹‹å‰ï¼‰
	srcInfo, _ := os.Stat(filePath)
	var creationTime time.Time
	if srcInfo != nil {
		if stat, ok := srcInfo.Sys().(*syscall.Stat_t); ok {
			creationTime = time.Unix(stat.Birthtimespec.Sec, stat.Birthtimespec.Nsec)
		}
	}
	
	logger.Printf("ğŸ¯ ä½¿ç”¨H.266/VVCç¼–ç å™¨ï¼ˆæœ€æ–°æ ‡å‡†ï¼Œæè‡´å‹ç¼©ï¼‰")
	
	// âœ… æ­¥éª¤2: ä½¿ç”¨H.266ç¼–ç 
	args := []string{
		"-i", filePath,
		"-c:v", "libvvenc",         // H.266/VVCç¼–ç å™¨
		"-qp", "28",                // è´¨é‡å‚æ•°ï¼ˆç±»ä¼¼H.265çš„CRF 28ï¼‰
		"-preset", "medium",        // é€Ÿåº¦é¢„è®¾ï¼ˆslower/slow/medium/fast/fasterï¼‰
		"-pix_fmt", "yuv420p",      // åƒç´ æ ¼å¼
		"-map_metadata", "0",       // âœ… å¤åˆ¶æ‰€æœ‰å…ƒæ•°æ®
		"-movflags", "use_metadata_tags", // âœ… ä¿ç•™MOVå…ƒæ•°æ®æ ‡ç­¾
		"-f", "mov",                // MOVæ ¼å¼
		"-y", outputPath,           // è¦†ç›–è¾“å‡º
	}

	ctx, cancel := context.WithTimeout(globalCtx, time.Duration(opts.TimeoutSeconds)*time.Second)
	defer cancel()

	cmd := exec.CommandContext(ctx, "ffmpeg", args...)
	if output, err := cmd.CombinedOutput(); err != nil {
		return conversionMode, "", string(output), fmt.Errorf("ffmpeg H.266ç¼–ç å¤±è´¥: %v\nè¾“å‡º: %s", err, string(output))
	}

	logger.Printf("âœ… åŠ¨å›¾è½¬MOVæˆåŠŸï¼ˆH.266ç¼–ç ï¼‰: %s", filepath.Base(outputPath))

	// âœ… æ­¥éª¤3: å¤åˆ¶EXIFå…ƒæ•°æ®ï¼ˆä¼šæ”¹å˜æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼‰
	if err := copyMetadata(filePath, outputPath); err != nil {
		logger.Printf("âš ï¸  EXIFå…ƒæ•°æ®å¤åˆ¶å¤±è´¥: %s -> %s: %v",
			filepath.Base(filePath), filepath.Base(outputPath), err)
	} else {
		logger.Printf("âœ… EXIFå…ƒæ•°æ®å¤åˆ¶æˆåŠŸ: %s", filepath.Base(outputPath))
	}

	// âœ… æ­¥éª¤4: æ¢å¤æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ï¼ˆåœ¨exiftoolä¹‹åï¼‰
	if srcInfo != nil {
		// 4.1 æ¢å¤Finderæ ‡ç­¾å’Œæ³¨é‡Š
		if err := copyFinderMetadata(filePath, outputPath); err != nil {
			logger.Printf("âš ï¸  Finderå…ƒæ•°æ®å¤åˆ¶å¤±è´¥ %s: %v", filepath.Base(outputPath), err)
		} else {
			logger.Printf("âœ… Finderå…ƒæ•°æ®å¤åˆ¶æˆåŠŸ: %s", filepath.Base(outputPath))
		}

		// 4.2 æ¢å¤ä¿®æ”¹æ—¶é—´å’Œåˆ›å»ºæ—¶é—´ï¼ˆä½¿ç”¨touchç»Ÿä¸€è®¾ç½®ï¼‰
		if !creationTime.IsZero() {
			timeStr := creationTime.Format("200601021504.05")
			touchCmd := exec.Command("touch", "-t", timeStr, outputPath)
			if err := touchCmd.Run(); err != nil {
				logger.Printf("âš ï¸  æ–‡ä»¶æ—¶é—´æ¢å¤å¤±è´¥ %s: %v", filepath.Base(outputPath), err)
			} else {
				logger.Printf("âœ… æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®å·²ä¿ç•™: %s (åˆ›å»º/ä¿®æ”¹: %s)",
					filepath.Base(outputPath), creationTime.Format("2006-01-02 15:04:05"))
			}
		}
	}

	return conversionMode, outputPath, "", nil
}

