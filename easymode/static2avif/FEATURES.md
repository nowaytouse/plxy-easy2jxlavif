# 静态图片转AVIF工具功能介绍

## 项目概述

本项目实现了一个高性能、易使用的命令行工具 `static2avif`，专门用于将静态图片（JPEG、PNG、BMP、TIFF等）转换为现代的AVIF格式。该工具具有以下特点：

1. **高质量转换**：使用FFmpeg和SVT-AV1编码器实现高质量的图像转换
2. **高性能并发处理**：支持多线程并发处理，充分利用多核CPU性能
3. **智能格式检测**：自动识别静态图像格式并应用相应的转换策略
4. **完善的错误处理**：支持重试机制和优雅退出
5. **详细的日志记录**：提供全面的处理日志和统计信息

## 核心功能

### 1. 格式支持
- **输入格式**：JPEG、PNG、BMP、TIFF
- **输出格式**：AVIF

### 2. 转换特性
- **高质量转换**：可调节的转换质量参数（0-100）
- **速度优化**：可调节的编码速度参数（0-10）
- **并发处理**：支持多线程并发转换，提高处理效率

### 3. 智能处理
- **自动格式识别**：自动检测输入文件的格式
- **试运行模式**：支持试运行模式，预览将要处理的文件
- **跳过已存在**：支持跳过已存在的输出文件，避免重复转换

### 4. 错误处理与恢复
- **重试机制**：支持配置重试次数，处理临时故障
- **超时控制**：单个文件处理超时控制，避免长时间阻塞
- **优雅退出**：支持SIGINT/SIGTERM信号的优雅退出

## 技术实现

### 1. 核心组件
- **主控制器**：负责程序流程控制和参数解析
- **文件扫描器**：高效遍历目录并识别支持的文件格式
- **转换引擎**：调用FFmpeg进行图像格式转换

### 2. 依赖库
- **godirwalk**：高性能目录遍历库
- **filetype**：快速文件类型识别库
- **ants**：高性能 goroutine 池
- **FFmpeg**：强大的多媒体处理工具

### 3. 转换策略
- 使用 `libsvtav1` 编码器实现高质量AVIF编码
- 根据质量参数动态调整CRF值
- 根据速度参数调整编码预设

## 使用场景

### 1. 网站优化
将网站中的JPEG/PNG图片转换为AVIF格式，显著减小文件大小，提高页面加载速度。

### 2. 图像收藏管理
批量转换个人图像收藏中的静态图片，节省存储空间。

### 3. 内容创作
为内容创作者提供高效的静态图像格式转换工具。

## 性能优势

### 1. 文件大小优化
AVIF格式相比传统静态图像格式具有更高的压缩率，在保持视觉质量的同时显著减小文件大小。

### 2. 处理速度
- 智能线程配置，充分利用多核CPU
- 预分配线程池，减少资源分配开销
- 并发控制机制，避免系统过载

### 3. 资源管理
- 进程级并发限制，避免过多并发进程
- 文件句柄限制，防止资源耗尽
- 信号量机制，确保资源安全访问

## 安装与使用

### 系统要求
- Go 1.19 或更高版本
- FFmpeg 4.0 或更高版本

### 构建方式
```bash
# 克隆项目
git clone <项目地址>

# 进入项目目录
cd static2avif

# 构建项目
./build.sh
```

### 基本使用
```bash
# 转换整个目录
./bin/static2avif -input /path/to/images -output /path/to/avif/output

# 高质量转换
./bin/static2avif -input /input -output /output -quality 80 -speed 5
```

## 项目文件结构

```
static2avif/
├── main.go                 # 主程序文件
├── README.md               # 用户使用说明
├── PROCESSING_FLOW.md      # 技术处理流程文档
├── build.sh                # 构建脚本
├── test.sh                 # 测试脚本
├── go.mod                  # Go模块定义
├── go.sum                  # 依赖版本锁定
└── bin/
    └── static2avif         # 编译后的可执行文件
```

## 总结

`static2avif` 工具为需要将静态图片转换为现代AVIF格式的用户提供了一个完整、高效的解决方案。通过智能的格式检测、高质量的转换算法和完善的错误处理机制，该工具能够安全、可靠地完成批量图像转换任务，帮助用户优化图像存储和传输。