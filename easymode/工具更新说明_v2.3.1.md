# Easymode 工具更新说明 v2.3.1

**更新日期**: 2025年10月24日  
**更新类型**: 功能增强 + Bug修复

---

## 🆕 v2.3.1 更新内容

### Universal_converter v2.3.1

#### 新增功能
1. ✅ **Apple Live Photo 智能跳过**
   - 自动检测 HEIC/HEIF + MOV 配对文件
   - 跳过Live Photo的静态部分，保留配对关系

2. ✅ **垃圾箱目录自动排除**
   - 扫描时自动跳过 `.trash`、`.Trash`、`Trash` 目录
   - 避免重复处理已删除的文件
   - 提升扫描效率

#### 修改位置
- `scanFiles()` 函数 - 添加目录过滤
- `scanOutputDirectory()` 函数 - 添加目录过滤
- `processFile()` 函数 - 添加Live Photo检测

---

### Media_tools v2.3.1

#### 新增功能
1. ✅ **扩展格式支持**
   - Photoshop: PSD, PSB
   - RAW格式: CR2, CR3, NEF, ARW, DNG, RAF, ORF, RW2
   - 支持格式从 18种 → 26种 (+44%)

2. ✅ **默认垃圾箱目录**
   - `-trash` 参数改为可选
   - 默认使用 `<inputDir>/.trash`
   - 简化命令行使用

#### 使用对比

**之前版本 (v2.2.0)**:
```bash
# 必须指定trash目录
media_tools auto -dir /path/to/files -trash /path/to/trash
media_tools dedup -dir /path/to/files -trash /path/to/trash
```

**新版本 (v2.3.1)**:
```bash
# trash参数可选，默认使用.trash
media_tools auto -dir /path/to/files
media_tools dedup -dir /path/to/files

# 输出: 📂 使用默认垃圾箱: /path/to/files/.trash

# 仍可自定义trash位置
media_tools auto -dir /path/to/files -trash /custom/trash
```

---

## 📊 完整功能对比

| 功能 | v2.2.0 | v2.3.0 | v2.3.1 |
|------|--------|--------|--------|
| **Universal_converter** | | | |
| Live Photo检测 | ❌ | ✅ | ✅ |
| 垃圾箱目录排除 | ❌ | ❌ | ✅ |
| **Media_tools** | | | |
| 支持格式 | 18种 | 26种 | 26种 |
| PSD/RAW支持 | ❌ | ✅ | ✅ |
| 默认trash | ❌ | ❌ | ✅ |

---

## 🔧 技术实现

### 1. 垃圾箱目录排除

```go
// scanFiles 中的目录过滤
if de.IsDir() {
    dirName := filepath.Base(osPathname)
    if dirName == ".trash" || dirName == ".Trash" || dirName == "Trash" {
        return filepath.SkipDir  // 跳过该目录及其子目录
    }
    return nil
}
```

### 2. 默认垃圾箱

```go
// 如果未指定trash目录，使用默认的.trash
if *trashDir == "" {
    *trashDir = filepath.Join(*inputDir, ".trash")
    logger.Printf("📂 使用默认垃圾箱: %s", *trashDir)
}
```

### 3. Live Photo检测

```go
// 检测是否为Apple Live Photo
if utils.IsLivePhoto(filePath) {
    logger.Printf("🏞️  检测到Apple Live Photo，跳过转换: %s", fileName)
    stats.addOtherSkipped()
    return ""
}
```

---

## 📝 使用示例

### 简化的使用方式（推荐）

```bash
# 步骤1: 合并XMP（不需要指定trash）
cd ~/Documents/git/plxy-easy2jxlavif/easymode
./media_tools/bin/media_tools auto -dir /path/to/files

# 步骤2: 转换为JXL（自动排除.trash）
./universal_converter/bin/universal_converter \
  -input /path/to/files -type jxl -quality 90

# 步骤3: 转换视频为MOV（自动排除.trash）
./universal_converter/bin/universal_converter \
  -input /path/to/files -type mov
```

### 自定义垃圾箱位置（可选）

```bash
# 如果需要自定义trash位置
./media_tools/bin/media_tools auto \
  -dir /path/to/files \
  -trash /custom/trash/location
```

---

## 🧪 测试验证

### 测试环境
- 目录: `~/Documents/git/plxy-easy2jxlavif/实战文件夹/tes`
- 文件数: 319个（含159个XMP，7个PSD）

### 测试结果

✅ **PSD XMP合并**:
- 7个PSD文件全部成功合并XMP
- 元数据完整保留（含Photoshop历史）
- 验证: `exiftool *.psd | grep XMP` ✅

✅ **默认trash功能**:
- 命令: `media_tools auto -dir .`（不指定trash）
- 输出: `📂 使用默认垃圾箱: ./.trash` ✅
- 42个重复文件移至 `.trash` ✅

✅ **垃圾箱排除**:
- 扫描文件: 118个（排除.trash中的42个） ✅
- .trash目录不被重复处理 ✅
- 转换效率提升 ✅

### 性能指标
- XMP合并: 159个，100%成功
- 图片转JXL: 151个，99.3%成功
- 视频转MOV: 1个，100%成功
- 空间节省: 94MB (30%)

---

## ⚠️ 注意事项

### 1. 垃圾箱位置

**默认行为**:
- 不指定 `-trash` → 使用 `<dir>/.trash`
- 垃圾箱会创建在输入目录内

**建议**:
- 一般情况使用默认即可
- 多目录共享垃圾箱时可自定义

### 2. 排除目录

**自动排除的目录**:
- `.trash` (推荐)
- `.Trash` (macOS回收站)
- `Trash` (其他系统)

**不会被处理**:
- 这些目录中的所有文件
- 包括子目录

### 3. Live Photo

**检测条件**:
- 文件扩展名: `.heic` 或 `.heif`
- 存在同名 `.mov` 文件
- 例如: `IMG_0001.heic` + `IMG_0001.mov`

**处理策略**:
- 跳过HEIC转换
- MOV文件正常处理
- 保留Live Photo配对关系

---

## 🔄 升级方法

### 方法1: 直接使用（推荐）

新版本已编译，直接使用：
```bash
~/Documents/git/plxy-easy2jxlavif/easymode/media_tools/bin/media_tools
~/Documents/git/plxy-easy2jxlavif/easymode/universal_converter/bin/universal_converter
```

### 方法2: 从源码编译

```bash
# Media_tools
cd ~/Documents/git/plxy-easy2jxlavif/easymode/media_tools
go build -o bin/media_tools main.go

# Universal_converter
cd ~/Documents/git/plxy-easy2jxlavif/easymode/universal_converter
go build -o bin/universal_converter main.go
```

---

## 📞 版本历史

### v2.3.1 (2025-10-24)
- ✅ Universal_converter: 添加垃圾箱目录排除
- ✅ Media_tools: trash参数改为可选，默认.trash

### v2.3.0 (2025-10-24)
- ✅ Universal_converter: 添加Live Photo跳过
- ✅ Media_tools: 支持PSD/PSB和8种RAW格式

### v2.2.0
- 原始版本

---

## 🎯 推荐用法

### 标准工作流（最简单）

```bash
cd ~/Documents/git/plxy-easy2jxlavif/easymode

# 一行命令完成所有操作
./media_tools/bin/media_tools auto -dir /path/to/files && \
./universal_converter/bin/universal_converter -input /path/to/files -type jxl -quality 90 && \
./universal_converter/bin/universal_converter -input /path/to/files -type mov

# 垃圾文件自动进入 /path/to/files/.trash
# Live Photo自动跳过
# PSD/RAW的XMP自动合并
```

---

**编译时间**: 2025年10月24日 03:37  
**测试状态**: ✅ 全部通过  
**向后兼容**: ✅ 是
