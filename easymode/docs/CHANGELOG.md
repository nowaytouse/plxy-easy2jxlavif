# 更新日志 / Changelog

## v2.2.1 (2025-10-23) - 智能资源管理优化

### 🚀 性能优化

#### 智能Effort策略
- **动态调整压缩级别**：根据文件大小自动选择最优effort
  - < 500KB: effort 9 (最高压缩)
  - < 2MB: effort 8
  - < 5MB: effort 7
  - < 10MB: effort 6
  - ≥ 10MB: effort 5 (避免内存耗尽)
- **效果**：大幅降低大文件转换时的内存占用，避免系统OOM

#### 智能超时机制
- **动态超时时间**：根据文件大小自动调整超时
  - < 500KB: 30秒
  - < 2MB: 60秒
  - < 5MB: 120秒
  - < 10MB: 300秒
  - ≥ 10MB: 600秒
- **效果**：解决大文件因超时被系统kill的问题

#### 智能并发控制
- **CPU自适应**：根据CPU核心数自动优化并发配置
  - Mac Mini M4 (10核): 4进程 × 4线程
  - 8核CPU: 3进程 × 3线程
  - 4核CPU: 2进程 × 2线程
  - 低于4核: 1进程 × 1线程
- **通用检测**：使用`runtime.NumCPU()`自动适配所有CPU架构
- **效果**：预留系统资源，避免过度并发导致内存耗尽

### 🐛 问题修复

- **修复signal: killed错误**：优化前失败率21.5%，优化后预期<5%
- **修复内存耗尽问题**：大文件转换时降低effort和增加超时
- **修复超时杀进程问题**：动态超时机制确保大文件有足够处理时间

### 📝 技术细节

- 新增函数：`getSmartEffort()` - 智能effort选择
- 新增函数：`getSmartTimeout()` - 智能超时计算
- 新增函数：`getSmartProcessLimit()` - 智能进程数计算
- 新增函数：`getSmartCJXLThreads()` - 智能线程数计算
- 新增文档：`docs/OPTIMIZATION_v2.2.1.md` - 详细优化说明

### ⚠️ 重要提示

- **数学无损保证**：所有优化均保持数学无损特性
  - JPEG: `--lossless_jpeg=1`
  - PNG/GIF: `-d 0` (distance=0)
- **压缩率影响**：effort 5 vs 9 压缩率差异通常<5%
- **默认配置**：已优化为最佳平衡（压缩/速度/稳定性）

---

## v2.2.0 (2025-10-23) - 转换后验证系统

### 🎉 新增功能

#### 转换后验证系统
- **抽样验证机制**：自动对转换后的文件进行抽样检查（默认10%抽样率，最少5个，最多20个）
- **多维度验证**：
  - **动图验证**：检查FPS、帧数、分辨率（确保无裁切）
  - **静图验证**：检查分辨率（确保无裁切）、单帧确认
  - **视频验证**：检查分辨率、时长
- **智能适配**：自动适应in-place转换模式（原始文件已删除时只验证输出文件存在性）
- **友好报告**：
  - 显示抽样文件数和总文件数
  - 显示每个文件的验证结果和问题详情
  - 根据通过率给出不同级别的判断（95%+优秀，80-95%警告，<80%失败）

### 🔧 修复

- 修复了`processFile`函数的返回值问题，现在正确返回输出路径
- 修复了`utils/post_validation.go`中缺少`os`包导入的问题
- 修复了正则表达式语法错误（`regexp.MustCompile`缺少括号）

### 📝 技术细节

- 新增文件：`utils/post_validation.go` - 完整的转换后验证模块
- 使用`ffprobe`获取媒体属性（宽度、高度、帧数、FPS、时长）
- 备用方案：当`ffprobe`失败时使用`identify`（ImageMagick）
- 验证结果包含详细的检查项和问题列表

---

## v2.1.0 (2025-10-23) - 统一媒体工具集

### 🎉 新增功能

#### 转换后验证系统
- **抽样验证机制**：自动对转换后的文件进行抽样检查（默认10%抽样率，最少5个，最多20个）
- **多维度验证**：
  - **动图验证**：检查FPS、帧数、分辨率（确保无裁切）
  - **静图验证**：检查分辨率（确保无裁切）、单帧确认
  - **视频验证**：检查分辨率、时长
- **智能适配**：自动适应in-place转换模式（原始文件已删除时只验证输出文件存在性）
- **友好报告**：
  - 显示抽样文件数和总文件数
  - 显示每个文件的验证结果和问题详情
  - 根据通过率给出不同级别的判断（95%+优秀，80-95%警告，<80%失败）

### 🔧 修复

- 修复了`processFile`函数的返回值问题，现在正确返回输出路径
- 修复了`utils/post_validation.go`中缺少`os`包导入的问题
- 修复了正则表达式语法错误（`regexp.MustCompile`缺少括号）

### 📝 技术细节

- 新增文件：`utils/post_validation.go` - 完整的转换后验证模块
- 使用`ffprobe`获取媒体属性（宽度、高度、帧数、FPS、时长）
- 备用方案：当`ffprobe`失败时使用`identify`（ImageMagick）
- 验证结果包含详细的检查项和问题列表

---

## v2.2.0 (2025-10-23)

### 🎉 新增功能

#### 统一媒体工具集 (media_tools)
- **合并工具**：将`merge_xmp`和`deduplicate_media`合并为单一工具
- **新增命令**：
  - `merge` - XMP元数据合并
  - `dedup` - 重复文件检测和清理
  - `normalize` - 文件扩展名规范化（.jpeg→.jpg, .tiff→.tif）
  - `auto` - 自动执行全部操作（推荐）
- **智能执行顺序**：`normalize` → `merge` → `dedup`
- **路径容错**：完全支持包含空格、中文、特殊符号的路径
- **试运行模式**：所有命令支持`-dry-run`参数

#### Universal Converter 增强
- **AVIF转换优化**：
  - 动态AVIF：使用`ffmpeg`（libaom-av1编码器）
  - 静态AVIF：使用官方`avifenc`工具
  - 移除对`magick`的依赖
- **自动依赖安装**：检测到缺失工具时自动使用`brew install`安装
- **智能排序**：按文件大小升序处理，优化感官速度
- **后处理扫描**：转换完成后统计输出目录文件数
- **路径容错**：完全支持包含空格、中文、特殊符号的路径
- **MOV重新包装**：集成视频格式转换功能

### 🔧 优化改进

- **元数据复制**：失败时记录为非致命警告，不阻止转换成功
- **验证范围调整**：JPEG→AVIF的文件大小比例验证范围调整为0.05-3.0，适应AVIF高压缩率
- **代码注释**：全部转换为简体中文
- **日志优化**：更清晰的emoji和文字提示

### 📚 文档更新

- 新增`CHANGELOG.md`更新日志
- 更新`README.md`和`README_ZH.md`
- 新增`media_tools`完整使用文档
- 新增8层验证系统详细说明
- 新增智能路由策略说明

### 🗑️ 归档工具

以下工具已移至`_cleanup`文件夹（功能已集成到新工具）：
- `merge_xmp` → 集成到`media_tools`
- `deduplicate_media` → 集成到`media_tools`
- `video2mov` → 集成到`universal_converter`
- `all2avif`, `all2jxl` → 被`universal_converter`替代
- `static2avif`, `static2jxl` → 被`universal_converter`替代
- `dynamic2avif`, `dynamic2jxl` → 被`universal_converter`替代

### 🧪 测试验证

- 完成中等规模测试（892个文件）
- 完成针对性测试（180个JPEG→AVIF转换）
- 完成最终集成测试
- 所有功能验证通过

### 📦 系统要求

- Go 1.22+
- exiftool
- libavif (avifenc)
- ffmpeg
- jpeg-xl (cjxl, djxl)
- ImageMagick (可选，用于备用验证)

---

## v2.1.1 及更早版本

请参阅`docs/`目录中的历史文档。
